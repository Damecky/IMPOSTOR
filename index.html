<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>üïµÔ∏è‚Äç‚ôÇÔ∏è IMPOSTOR GAME</title>
<style>
body {
  font-family: 'Segoe UI', sans-serif;
  background: #0d1117;
  color: #fff;
  text-align: center;
  margin: 0;
  padding: 0;
}
h1 {
  color: #00d26a;
  margin-top: 35px;
  font-size: 42px;
  text-shadow: 0 0 8px #00ff9d;
}
button {
  background: #00d26a;
  color: black;
  border: none;
  border-radius: 12px;
  padding: 18px 40px;
  font-size: 18px;
  margin: 10px 0;
  cursor: pointer;
  width: 80%;
  max-width: 320px;
  transition: all 0.2s;
}
button:hover {
  background: #00b85d;
  transform: scale(1.05);
}
input {
  font-size: 18px;
  padding: 12px;
  border-radius: 10px;
  border: 1px solid #ccc;
  width: 80%;
  max-width: 300px;
  text-align: center;
  margin-bottom: 10px;
}
.hidden { display: none; }
.card {
  margin-top: 20px;
  padding: 18px;
  background: #161b22;
  border-radius: 20px;
  display: inline-block;
  font-size: 22px;
  max-width: 90%;
  word-wrap: break-word;
  box-shadow: 0 0 15px rgba(0,255,150,0.1);
}
#wordDisplay {
  font-size: 28px;
  font-weight: bold;
  color: #00d26a;
  text-shadow: 0 0 10px #00d26a;
  margin-top: 10px;
}
#playersList span {
  display: inline-block;
  background: #00d26a;
  color: #000;
  padding: 10px 18px;
  border-radius: 10px;
  margin: 6px;
  cursor: pointer;
  transition: all 0.2s;
}
#playersList span:hover { background: #00b85d; transform: scale(1.05); }
#scoreBoard {
  margin-top: 20px;
  padding: 15px;
  background: #11151d;
  border-radius: 12px;
  display: inline-block;
}
</style>
</head>
<body>

<h1>üïµÔ∏è‚Äç‚ôÇÔ∏è IMPOSTOR GAME</h1>

<!-- Menu startowe -->
<div id="menu">
  <input id="playerName" placeholder="Twoje imiƒô" />
  <button id="btnCreate">Stw√≥rz grƒô</button>
  <p style="margin:10px 0;">lub</p>
  <input id="joinCode" placeholder="Kod pokoju" />
  <button id="btnJoin">Do≈ÇƒÖcz</button>
</div>

<!-- Panel hosta -->
<div id="hostPanel" class="hidden">
  <h2>Kod pokoju: <span id="roomCode"></span></h2>
  <p id="roundCount">Runda: 0/10</p>
  <p id="players">Gracze: 0/4</p>
  <p id="playerList"></p>
  <button id="btnStart">Rozdaj role</button>
  <button id="btnNextRound" class="hidden">Rozlosuj kolejnƒÖ rundƒô</button>
  <button id="btnImpostorWin" class="hidden">Impostor odgad≈Ç has≈Ço</button>
  <div id="scoreBoard" class="hidden"></div>
</div>

<!-- Widok gracza -->
<div id="waiting" class="hidden">
  <h2 id="statusText">Oczekiwanie na rozpoczƒôcie...</h2>
  <div id="myName" class="card"></div>
  <div id="wordDisplay"></div>
  <div id="playersList"></div>
  <button id="btnVote" class="hidden">Potwierd≈∫ g≈Ços</button>
</div>

<!-- Wynik rundy -->
<div id="result" class="hidden card"></div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAy1mE_Q3fJo9W2Aa9EQUqp0L0Bn53XPHc",
  authDomain: "impostor-game-ebc12.firebaseapp.com",
  databaseURL: "https://impostor-game-ebc12-default-rtdb.europe-west1.firebasedatabase.app/",
  projectId: "impostor-game-ebc12",
  storageBucket: "impostor-game-ebc12.appspot.com",
  messagingSenderId: "561452405867",
  appId: "1:561452405867:web:24fb4cdf0320c2c3488d2e",
  measurementId: "G-DKBLTBFHJ5"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const words = ["OKO","DARMOZJAD","TIKTOK","MEM","NETFLIX","LODY","ROWER","≈ªABKA","AGRECOL","PIZZA","PASTA","SIGMA","SNAP","DISCORD","SZKO≈ÅA","TRAMWAJ","WAKACJE","KOT","PIES","IPHONE","SPORT","DOM","BUDYNEK","FILM","SUSHI","POCIƒÑG","JARMARK","SZKLANKA"];

let playerId = Math.random().toString(36).substring(2,9);
let roomRef = null;
let isHost = false;
let playerName = "";
let selectedVote = null;
let roundCount = 0;

function randomCode() { return Math.floor(1000 + Math.random() * 9000).toString(); }

function showScoreboard(scores) {
  let html = "<h3>Wyniki:</h3>";
  for (const [id, s] of Object.entries(scores)) html += `<div>${s.name}: ${s.points}</div>`;
  document.getElementById("scoreBoard").innerHTML = html;
  document.getElementById("scoreBoard").classList.remove("hidden");
}

async function updatePlayerList() {
  const snap = await roomRef.get();
  const data = snap.val();
  const playersList = data.players ? Object.values(data.players).map(p => p.name) : [];
  document.getElementById("playerList").innerText = playersList.join(", ");
  const nonHostCount = playersList.filter(n => !n.includes("(HOST)")).length;
  document.getElementById("players").innerText = `Gracze: ${nonHostCount}/4`;
}

function showVoteOptions(players) {
  const list = document.getElementById("playersList");
  list.innerHTML = "";
  players.forEach(p => {
    const span = document.createElement("span");
    span.textContent = p.name;
    span.onclick = () => {
      selectedVote = p.id;
      [...list.children].forEach(el => el.style.background = "#00d26a");
      span.style.background = "#00ffbb";
      document.getElementById("btnVote").classList.remove("hidden");
    };
    list.appendChild(span);
  });
}

function endRoundMessage(impostorName, correctGuessers) {
  let msg = "";
  if (correctGuessers.length > 0) msg = `üéâ GRATULACJE! Impostorem by≈Ç ${impostorName}`;
  else msg = `‚ùå PORA≈ªKA! Impostorem by≈Ç ${impostorName}`;
  document.getElementById("result").innerText = msg;
  document.getElementById("result").classList.remove("hidden");
}

async function createRoom() {
  playerName = document.getElementById("playerName").value.trim();
  if (!playerName) return alert("Podaj imiƒô!");
  playerName += " (HOST)";
  isHost = true;
  const code = randomCode();
  roomRef = db.ref("rooms/" + code);
  await roomRef.set({ players: {}, started: false, round: 0 });

  const playerRef = db.ref(`rooms/${code}/players/${playerId}`);
  await playerRef.set({ name: playerName, points: 0 });

  document.getElementById("menu").classList.add("hidden");
  document.getElementById("hostPanel").classList.remove("hidden");
  document.getElementById("roomCode").innerText = code;
  document.getElementById("scoreBoard").classList.remove("hidden");

  roomRef.on("value", async snap => {
    const data = snap.val();
    await updatePlayerList();
    if (data.scores) showScoreboard(data.scores);
    document.getElementById("roundCount").innerText = `Runda: ${data.round || 0}/10`;
    if (data.ended) showScoreboard(data.scores);
  });
}

async function joinRoom() {
  playerName = document.getElementById("playerName").value.trim();
  const code = document.getElementById("joinCode").value.trim();
  if (!playerName || !code) return alert("Podaj imiƒô i kod!");
  roomRef = db.ref("rooms/" + code);
  const snap = await roomRef.get();
  if (!snap.exists()) return alert("Pok√≥j nie istnieje!");
  const playerRef = db.ref(`rooms/${code}/players/${playerId}`);
  await playerRef.set({ name: playerName, points: 0 });

  document.getElementById("menu").classList.add("hidden");
  document.getElementById("waiting").classList.remove("hidden");
  document.getElementById("myName").innerText = `Twoje imiƒô: ${playerName}`;

  roomRef.on("value", snap => {
    const data = snap.val();
    if (data.started && data.roles && data.word && !data.ended) {
      const role = data.roles[playerId];
      if (role === "impostor") {
        document.getElementById("statusText").innerText = "üïµÔ∏è‚Äç‚ôÇÔ∏è Jeste≈õ IMPOSOTREM!";
        document.getElementById("wordDisplay").innerText = "";
      } else {
        document.getElementById("statusText").innerText = "ZGADNIJ IMPOSTORA";
        document.getElementById("wordDisplay").innerText = `Has≈Ço: ${data.word}`;
      }
      const players = Object.entries(data.players).filter(([id, p]) => id !== playerId && !p.name.includes("(HOST)")).map(([id, p]) => ({ id, name: p.name }));
      showVoteOptions(players);
    }
    if (data.showResult) endRoundMessage(data.impostorName, data.correctGuessers || []);
    if (data.scores) showScoreboard(data.scores);
  });
}

async function startGame() {
  const snap = await roomRef.get();
  const data = snap.val();
  const players = Object.keys(data.players || {}).filter(id => !data.players[id].name.includes("(HOST)"));
  if (players.length !== 4) return alert("Musi byƒá dok≈Çadnie 4 graczy!");
  const word = words[Math.floor(Math.random() * words.length)];
  const impostor = players[Math.floor(Math.random() * players.length)];
  const roles = {};
  players.forEach(p => roles[p] = p === impostor ? "impostor" : "normal");
  roles[playerId] = "host";
  roundCount = (data.round || 0) + 1;
  await roomRef.update({ started: true, roles, word, round: roundCount, showResult: false });
  document.getElementById("btnNextRound").classList.remove("hidden");
  document.getElementById("btnImpostorWin").classList.remove("hidden");
}

async function submitVote() {
  if (!selectedVote) return alert("Wybierz gracza!");
  const voteRef = roomRef.child("votes/" + playerId);
  await voteRef.set(selectedVote);
  document.getElementById("btnVote").classList.add("hidden");

  const snap = await roomRef.get();
  const data = snap.val();
  const allVotes = data.votes ? Object.values(data.votes) : [];
  if (allVotes.length === 4) {
    const impostorId = Object.entries(data.roles).find(([id, r]) => r === "impostor")[0];
    const correct = allVotes.filter(v => v === impostorId);
    const scores = data.scores || {};
    for (const [id, p] of Object.entries(data.players)) {
      if (!scores[id]) scores[id] = { name: p.name, points: 0 };
      if (correct.includes(id)) scores[id].points += 1;
    }
    await roomRef.update({
      showResult: true,
      impostorName: data.players[impostorId].name,
      correctGuessers: correct.map(id => data.players[id].name),
      scores
    });
  }
}

async function nextRound() {
  const snap = await roomRef.get();
  const data = snap.val();
  if ((data.round || 0) >= 10) {
    await roomRef.update({ ended: true });
    return;
  }
  const players = Object.keys(data.players || {}).filter(id => !data.players[id].name.includes("(HOST)"));
  const word = words[Math.floor(Math.random() * words.length)];
  const impostor = players[Math.floor(Math.random() * players.length)];
  const roles = {};
  players.forEach(p => roles[p] = p === impostor ? "impostor" : "normal");
  roles[playerId] = "host";
  await roomRef.update({ started: true, roles, word, votes: null, showResult: false, round: data.round + 1 });
  document.getElementById("result").classList.add("hidden");
}

async function impostorWin() {
  const snap = await roomRef.get();
  const data = snap.val();
  const impostorId = Object.entries(data.roles).find(([id, r]) => r === "impostor")[0];
  const scores = data.scores || {};
  const impostorName = data.players[impostorId].name;
  for (const [id, p] of Object.entries(data.players)) {
    if (!scores[id]) scores[id] = { name: p.name, points: 0 };
  }
  scores[impostorId].points += 5;
  await roomRef.update({ showResult: true, impostorName, correctGuessers: [impostorName], scores });
}

document.getElementById("btnCreate").addEventListener("click", createRoom);
document.getElementById("btnJoin").addEventListener("click", joinRoom);
document.getElementById("btnStart").addEventListener("click", startGame);
document.getElementById("btnVote").addEventListener("click", submitVote);
document.getElementById("btnNextRound").addEventListener("click", nextRound);
document.getElementById("btnImpostorWin").addEventListener("click", impostorWin);
</script>

</body>
</html>
