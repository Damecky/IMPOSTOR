<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title id="pageTitle">üïµÔ∏è‚Äç‚ôÇÔ∏è IMPOSTOR GAME</title>

<style>
:root{
  --bg0:#070a10;
  --bg1:#0d1117;
  --panel:#111824cc;
  --panelSolid:#111824;
  --stroke:#233041;
  --text:#e8eef7;
  --muted:#98a6b7;
  --brand:#00d26a;
  --brand2:#00ffa8;
  --danger:#ff4d6d;
  --shadow: 0 16px 50px rgba(0,0,0,.45);
  --shadowSoft: 0 10px 30px rgba(0,0,0,.28);
  --radius: 22px;
}

/* Ustawienia globalne */
*{ box-sizing:border-box; }
html,body{ height:100%; }
body{
  font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial, "Noto Sans",
    "Apple Color Emoji","Segoe UI Emoji";
  background:
    radial-gradient(900px 600px at 20% 10%, rgba(0,210,106,.22), transparent 60%),
    radial-gradient(700px 500px at 80% 25%, rgba(0,255,168,.14), transparent 60%),
    radial-gradient(900px 700px at 50% 110%, rgba(0,210,106,.12), transparent 60%),
    linear-gradient(180deg, var(--bg0), var(--bg1));
  color: var(--text);
  text-align: center;
  margin: 0;
  padding: 24px 14px 40px;
  overflow-x:hidden;
}

/* Delikatny ‚Äúnoise‚Äù */
body::before{
  content:"";
  position:fixed;
  inset:0;
  pointer-events:none;
  opacity:.06;
  background-image:
    repeating-linear-gradient(0deg, rgba(255,255,255,.08) 0 1px, transparent 1px 3px),
    repeating-linear-gradient(90deg, rgba(255,255,255,.05) 0 1px, transparent 1px 4px);
  mix-blend-mode: overlay;
}

/* Nag≈Ç√≥wek */
h1{
  margin: 18px 0 18px;
  font-size: clamp(30px, 4.6vw, 44px);
  letter-spacing:.5px;
  color: var(--text);
  text-shadow: 0 0 22px rgba(0,210,106,.22);
}

/* ‚ÄúApp shell‚Äù */
#menu, #hostPanel, #waiting{
  width: min(560px, 94vw);
  margin: 14px auto;
  padding: 20px 16px 18px;
  background: linear-gradient(180deg, rgba(17,24,36,.92), rgba(17,24,36,.72));
  border: 1px solid rgba(35,48,65,.75);
  border-radius: var(--radius);
  box-shadow: var(--shadowSoft);
  backdrop-filter: blur(10px);
}

/* Teksty */
p, h2{
  margin: 10px 0;
}
#orText{
  color: var(--muted);
  font-weight: 600;
}

/* Przyciski jƒôzyka */
.smallBtnRow{
  display:flex;
  gap:10px;
  justify-content:center;
  flex-wrap:wrap;
  margin: 6px auto 16px;
}

/* Buttony */
button{
  appearance:none;
  border:none;
  cursor:pointer;
  user-select:none;

  width: 88%;
  max-width: 340px;
  padding: 16px 18px;
  margin: 12px 0;

  border-radius: 16px;
  font-size: 18px;
  font-weight: 800;
  letter-spacing:.2px;

  color: #04150c;
  background: linear-gradient(135deg, var(--brand), var(--brand2));
  box-shadow:
    0 10px 25px rgba(0,210,106,.18),
    0 3px 0 rgba(0,0,0,.25);
  transform: translateY(0);
  transition: transform .12s ease, filter .12s ease, box-shadow .12s ease;
}

button:hover{
  filter: brightness(1.05);
  transform: translateY(-1px);
  box-shadow:
    0 14px 32px rgba(0,210,106,.22),
    0 3px 0 rgba(0,0,0,.25);
}

button:active{
  transform: translateY(1px);
  box-shadow:
    0 8px 18px rgba(0,210,106,.16),
    0 2px 0 rgba(0,0,0,.25);
}

button:focus-visible{
  outline: none;
  box-shadow:
    0 0 0 4px rgba(0,210,106,.22),
    0 12px 28px rgba(0,0,0,.35);
}

/* Ma≈Çe buttony (jƒôzyk) */
.smallBtnRow button{
  width:auto;
  max-width:none;
  margin: 0;
  padding: 10px 14px;
  font-size: 15px;
  border-radius: 14px;
  background: rgba(255,255,255,.06);
  color: var(--text);
  border: 1px solid rgba(35,48,65,.9);
  box-shadow: 0 10px 22px rgba(0,0,0,.18);
}

.smallBtnRow button:hover{
  background: rgba(255,255,255,.10);
  transform: translateY(-1px);
}

/* Inputy */
input{
  width: 88%;
  max-width: 340px;
  padding: 14px 14px;
  margin: 10px 0 6px;

  font-size: 18px;
  font-weight: 650;
  text-align:center;

  color: var(--text);
  background: rgba(255,255,255,.06);
  border: 1px solid rgba(35,48,65,.95);
  border-radius: 16px;
  outline: none;

  box-shadow: inset 0 0 0 1px rgba(0,0,0,.15);
  transition: border-color .12s ease, box-shadow .12s ease, transform .12s ease;
}

input::placeholder{ color: rgba(232,238,247,.55); }

input:focus{
  border-color: rgba(0,210,106,.85);
  box-shadow:
    0 0 0 4px rgba(0,210,106,.18),
    inset 0 0 0 1px rgba(0,0,0,.12);
}

/* Karty */
.card{
  width: min(760px, 94vw);
  margin: 18px auto 0;
  padding: 18px 18px;

  background: linear-gradient(180deg, rgba(22,27,34,.92), rgba(22,27,34,.72));
  border: 1px solid rgba(35,48,65,.85);
  border-radius: calc(var(--radius) + 2px);

  box-shadow: var(--shadow);
  backdrop-filter: blur(10px);

  font-size: clamp(18px, 2.6vw, 26px);
  font-weight: 900;
  color: var(--text);
  line-height: 1.25;
  white-space: pre-line;
}

.card::before{
  content:"";
  display:block;
  height: 4px;
  border-radius: 999px;
  margin-bottom: 12px;
  background: linear-gradient(90deg, var(--brand), var(--brand2));
  opacity:.9;
}

/* ‚ÄúmyName‚Äù mniej krzykliwe */
#myName{
  font-size: 16px;
  font-weight: 800;
  color: rgba(232,238,247,.92);
  text-shadow: none;
}

/* Ukrywanie */
.hidden{ display:none; }

/* Drobne dopieszczenie napis√≥w w panelu hosta */
#hostPanel h2{
  margin-top: 8px;
  font-size: 20px;
  color: rgba(232,238,247,.95);
}
#players, #playerList, #waitingText{
  color: var(--muted);
  font-weight: 650;
}

/* Animacja kart (opcjonalna wisienka) */
@keyframes pop {
  from { transform: translateY(6px); opacity: 0; }
  to   { transform: translateY(0); opacity: 1; }
}
.card:not(.hidden){
  animation: pop .18s ease-out;
}

/* Responsywno≈õƒá */
@media (max-width: 420px){
  button{ font-size: 16px; padding: 14px 16px; }
  input{ font-size: 16px; }
  #menu, #hostPanel, #waiting{ padding: 16px 12px; }
}
</style>
</head>

<body>

<h1 id="title">üïµÔ∏è‚Äç‚ôÇÔ∏è IMPOSTOR GAME</h1>

<!-- WYB√ìR JƒòZYKA -->
<div class="smallBtnRow">
  <button id="btnLangPl">üáµüá± POLSKI</button>
  <button id="btnLangDe">üá©üá™ DEUTSCH</button>
</div>

<div id="menu">
  <input id="playerName" placeholder="TWOJƒò IMIƒò" />
  <button id="btnCreate">STW√ìRZ GRƒò</button>
  <p id="orText" style="margin:10px 0;">lub</p>
  <input id="joinCode" placeholder="KOD POKOJU" />
  <button id="btnJoin">DO≈ÅƒÑCZ</button>
</div>

<div id="hostPanel" class="hidden">
  <h2><span id="roomCodeLabel">KOD POKOJU:</span> <span id="roomCode"></span></h2>
  <p id="players">GRACZE: 0/10</p>
  <p id="playerList"></p>
  <button id="btnStart">ROZDAJ ROLE</button>
  <button id="btnNextRound" class="hidden">ROZLOSUJ KOLEJNƒÑ RUNDƒò</button>
</div>

<div id="waiting" class="hidden">
  <h2 id="waitingText">OCZEKIWANIE NA ROZPOCZƒòCIE...</h2>
</div>

<div id="myName" class="hidden card"></div>
<div id="result" class="hidden card"></div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
/* ====== USTAWIENIE: ILO≈öƒÜ GRACZY (bez hosta) ====== */
const MAX_PLAYERS = 3-10;

/* ====== Firebase ====== */
const firebaseConfig = {
  apiKey: "AIzaSyAy1mE_Q3fJo9W2Aa9EQUqp0L0Bn53XPHc",
  authDomain: "impostor-game-ebc12.firebaseapp.com",
  databaseURL: "https://impostor-game-ebc12-default-rtdb.europe-west1.firebasedatabase.app/",
  projectId: "impostor-game-ebc12",
  storageBucket: "impostor-game-ebc12.appspot.com",
  messagingSenderId: "561452405867",
  appId: "1:561452405867:web:24fb4cdf0320c2c3488d2e",
  measurementId: "G-DKBLTBFHJ5"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ====== KATEGORIE PL/DE ====== */
const CATEGORIES = {
  body:      { pl: "Cia≈Ço", de: "K√∂rper" },
  animals:   { pl: "Zwierzƒôta", de: "Tiere" },
  places:    { pl: "Miejsca", de: "Orte" },
  transport: { pl: "Transport", de: "Transport" },
  tech:      { pl: "Technologia", de: "Technik" },
  food:      { pl: "Jedzenie", de: "Essen" },
  drinks:    { pl: "Napoje", de: "Getr√§nke" },
  seasons:   { pl: "Pory roku", de: "Jahreszeiten" },
  weather:   { pl: "Pogoda", de: "Wetter" },
  events:    { pl: "Wydarzenia", de: "Events" },
  sport:     { pl: "Sport", de: "Sport" },
  shopping:  { pl: "Zakupy", de: "Einkaufen" },
  time:      { pl: "Czas", de: "Zeit" },
  relations: { pl: "Relacje", de: "Beziehungen" },
  school:    { pl: "Szko≈Ça", de: "Schule" },
  home:      { pl: "Dom", de: "Zuhause" },
  jobs:      { pl: "Zawody", de: "Berufe" },
  nature:    { pl: "Natura", de: "Natur" },
  sweets:    { pl: "S≈Çodycze", de: "S√º√ües" },
  music:     { pl: "Muzyka", de: "Musik" },
  social:    { pl: "Internet", de: "Internet" },
  clothes:   { pl: "Ubrania", de: "Kleidung" }
};

/* ====== HAS≈ÅA POD KATEGORIAMI PL/DE ====== */
const WORDS = {
  body: {
    oko: { pl: "OKO", de: "AUGE" },
    ucho:{ pl: "UCHO", de: "OHR" },
    nos: { pl: "NOS", de: "NASE" },
    reka:{ pl: "RƒòKA", de: "HAND" },
    noga:{ pl: "NOGA", de: "BEIN" },
  },
  animals: {
    kot: { pl: "KOT", de: "KATZE" },
    pies:{ pl: "PIES", de: "HUND" },
    ptak:{ pl: "PTAK", de: "VOGEL" },
    ryba:{ pl: "RYBA", de: "FISCH" },
    kon: { pl: "KO≈É", de: "PFERD" },
  },
  places: {
    dom:   { pl: "DOM", de: "HAUS" },
    szkola:{ pl: "SZKO≈ÅA", de: "SCHULE" },
    praca: { pl: "PRACA", de: "ARBEIT" },
    miasto:{ pl: "MIASTO", de: "STADT" },
    wies:  { pl: "WIE≈ö", de: "DORF" },
    park:  { pl: "PARK", de: "PARK" },
    las:   { pl: "LAS", de: "WALD" },
    jezioro:{ pl: "JEZIORO", de: "SEE" },
    morze:  { pl: "MORZE", de: "MEER" },
    gory:   { pl: "G√ìRY", de: "BERGE" },
  },
  transport: {
    auto:   { pl: "AUTO", de: "AUTO" },
    rower:  { pl: "ROWER", de: "FAHRRAD" },
    pociag: { pl: "POCIƒÑG", de: "ZUG" },
    autobus:{ pl: "AUTOBUS", de: "BUS" },
    tramwaj:{ pl: "TRAMWAJ", de: "STRA√üENBAHN" },
  },
  tech: {
    telefon:  { pl: "TELEFON", de: "HANDY" },
    komputer: { pl: "KOMPUTER", de: "COMPUTER" },
    internet: { pl: "INTERNET", de: "INTERNET" },
    gra:      { pl: "GRA", de: "SPIEL" },
    film:     { pl: "FILM", de: "FILM" },
  },
  food: {
    pizza:     { pl: "PIZZA", de: "PIZZA" },
    hamburger: { pl: "HAMBURGER", de: "HAMBURGER" },
    kanapka:   { pl: "KANAPKA", de: "SANDWICH" },
    makaron:   { pl: "MAKARON", de: "NUDELN" },
    zupa:      { pl: "ZUPA", de: "SUPPE" },
  },
  drinks: {
    woda:    { pl: "WODA", de: "WASSER" },
    kawa:    { pl: "KAWA", de: "KAFFEE" },
    herbata: { pl: "HERBATA", de: "TEE" },
    sok:     { pl: "SOK", de: "SAFT" },
    mleko:   { pl: "MLEKO", de: "MILCH" },
  },
  seasons: {
    lato:   { pl: "LATO", de: "SOMMER" },
    zima:   { pl: "ZIMA", de: "WINTER" },
    wiosna: { pl: "WIOSNA", de: "FR√úHLING" },
    jesien: { pl: "JESIE≈É", de: "HERBST" },
  },
  weather: {
    pogoda: { pl: "POGODA", de: "WETTER" },
    deszcz: { pl: "DESZCZ", de: "REGEN" },
    snieg:  { pl: "≈öNIEG", de: "SCHNEE" },
    wiatr:  { pl: "WIATR", de: "WIND" },
    slonce: { pl: "S≈ÅO≈ÉCE", de: "SONNE" },
    chmury: { pl: "CHMURY", de: "WOLKEN" },
  },
  events: {
    wakacje:{ pl: "WAKACJE", de: "URLAUB" },
    weekend:{ pl: "WEEKEND", de: "WOCHENENDE" },
    impreza:{ pl: "IMPREZA", de: "PARTY" },
    koncert:{ pl: "KONCERT", de: "KONZERT" },
  },
  sport: {
    sport:    { pl: "SPORT", de: "SPORT" },
    pilka:    { pl: "PI≈ÅKA", de: "BALL" },
    mecz:     { pl: "MECZ", de: "SPIEL" },
    basen:    { pl: "BASEN", de: "SCHWIMMBAD" },
    silownia: { pl: "SI≈ÅOWNIA", de: "FITNESSSTUDIO" },
    bieganie: { pl: "BIEGANIE", de: "LAUFEN" },
  },
  shopping: {
    pieniadze:{ pl: "PIENIƒÑDZE", de: "GELD" },
    sklep:    { pl: "SKLEP", de: "LADEN" },
    zakupy:   { pl: "ZAKUPY", de: "EINKAUF" },
    prezent:  { pl: "PREZENT", de: "GESCHENK" },
    promocja: { pl: "PROMOCJA", de: "ANGEBOT" },
  },
  time: {
    czas:   { pl: "CZAS", de: "ZEIT" },
    dzien:  { pl: "DZIE≈É", de: "TAG" },
    noc:    { pl: "NOC", de: "NACHT" },
    rano:   { pl: "RANO", de: "MORGEN" },
    wieczor:{ pl: "WIECZ√ìR", de: "ABEND" },
  },
  relations: {
    milosc:   { pl: "MI≈ÅO≈öƒÜ", de: "LIEBE" },
    przyjazn: { pl: "PRZYJA≈π≈É", de: "FREUNDSCHAFT" },
    rodzina:  { pl: "RODZINA", de: "FAMILIE" },
    dziecko:  { pl: "DZIECKO", de: "KIND" },
    rodzice:  { pl: "RODZICE", de: "ELTERN" },
  },
  school: {
    nauczyciel:{ pl: "NAUCZYCIEL", de: "LEHRER" },
    uczen:     { pl: "UCZE≈É", de: "SCH√úLER" },
    ksiazka:   { pl: "KSIƒÑ≈ªKA", de: "BUCH" },
    zeszyt:    { pl: "ZESZYT", de: "HEFT" },
    dlugopis:  { pl: "D≈ÅUGOPIS", de: "KUGELSCHREIBER" },
  },
  home: {
    stol:    { pl: "ST√ì≈Å", de: "TISCH" },
    krzeslo: { pl: "KRZES≈ÅO", de: "STUHL" },
    lozko:   { pl: "≈Å√ì≈ªKO", de: "BETT" },
    okno:    { pl: "OKNO", de: "FENSTER" },
    drzwi:   { pl: "DRZWI", de: "T√úR" },
    kuchnia: { pl: "KUCHNIA", de: "K√úCHE" },
    lazienka:{ pl: "≈ÅAZIENKA", de: "BADEZIMMER" },
    pokoj:   { pl: "POK√ìJ", de: "ZIMMER" },
    ogrod:   { pl: "OGR√ìD", de: "GARTEN" },
    balkon:  { pl: "BALKON", de: "BALKON" },
  },
  jobs: {
    policja:     { pl: "POLICJA", de: "POLIZEI" },
    lekarz:      { pl: "LEKARZ", de: "ARZT" },
    pielegniarka:{ pl:"PIELƒòGNIARKA", de:"KRANKENSCHWESTER" },
    strazak:     { pl: "STRA≈ªAK", de: "FEUERWEHRMANN" },
    mechanik:    { pl: "MECHANIK", de: "MECHANIKER" },
  },
  sweets: {
    lod:      { pl: "L√ìD", de: "EIS" },
    lody:     { pl: "LODY", de: "EISCREME" },
    ciasto:   { pl: "CIASTO", de: "KUCHEN" },
    czekolada:{ pl: "CZEKOLADA", de: "SCHOKOLADE" },
    cukier:   { pl: "CUKIER", de: "ZUCKER" },
  },
  music: {
    muzyka:  { pl: "MUZYKA", de: "MUSIK" },
    gitara:  { pl: "GITARA", de: "GITARRE" },
    pianino: { pl: "PIANINO", de: "KLAVIER" },
    taniec:  { pl: "TANIEC", de: "TANZ" },
    piosenka:{ pl: "PIOSENKA", de: "LIED" },
  },
  social: {
    facebook:{ pl: "FACEBOOK", de: "FACEBOOK" },
    youtube: { pl: "YOUTUBE", de: "YOUTUBE" },
    discord: { pl: "DISCORD", de: "DISCORD" },
    mem:     { pl: "MEM", de: "MEME" },
    netflix: { pl: "NETFLIX", de: "NETFLIX" },
  },
  clothes: {
    ubranie:{ pl: "UBRANIE", de: "KLEIDUNG" },
    buty:   { pl: "BUTY", de: "SCHUHE" },
    czapka: { pl: "CZAPKA", de: "M√úTZE" },
    kurtka: { pl: "KURTKA", de: "JACKE" },
    plecak: { pl: "PLECAK", de: "RUCKSACK" },
  }
};

/* ====== STAN GRY ====== */
let playerId = Math.random().toString(36).substring(2,9);
let roomRef = null;
let isHost = false;
let playerName = "";

// do kontroli rund i countdownu
let lastSeenRound = null;
let countdownTimer = null;

/* ====== T≈ÅUMACZENIA UI ====== */
let lang = "pl";
const t = {
  pl: {
    title: "üïµÔ∏è‚Äç‚ôÇÔ∏è IMPOSTOR GAME",
    yourNamePh: "TWOJƒò IMIƒò",
    create: "STW√ìRZ GRƒò",
    or: "LUB",
    joinCodePh: "KOD POKOJU",
    join: "DO≈ÅƒÑCZ",
    roomCode: "KOD POKOJU:",
    players: "GRACZE",
    dealRoles: "ROZDAJ ROLE",
    nextRound: "ROZLOSUJ KOLEJNƒÑ RUNDƒò",
    waiting: "OCZEKIWANIE NA ROZPOCZƒòCIE...",
    guess: "ZGADNIJ IMPOSTORA",
    enterName: "PODAJ IMIƒò!",
    enterRoom: "PODAJ KOD POKOJU!",
    noRoom: "POK√ìJ NIE ISTNIEJE!",
    full: "POK√ìJ JEST PE≈ÅNY!",
    needExact: `MUSI BYƒÜ DOK≈ÅADNIE ${MAX_PLAYERS} GRACZY (bez hosta)!`,
    impostor: "üïµÔ∏è‚Äç‚ôÇÔ∏è JESTE≈ö IMPOSTOREM!",
    word: "üî§ HAS≈ÅO",
    roundStarted: "RUNDA ROZPOCZƒòTA!",
    myName: "TWOJE IMIƒò",
    wordMissing: "BRAK T≈ÅUMACZENIA HAS≈ÅA",
    category: "üìö KATEGORIA",
    startingIn: "NOWA RUNDA ZA",
    revealSoon: "SZYKUJ SIƒò"
  },
de: {
  title: "üïµÔ∏è‚Äç‚ôÇÔ∏è IMPOSTOR SPIEL",
  yourNamePh: "DEIN NAME",
  create: "SPIEL ERSTELLEN",
  or: "ODER",
  joinCodePh: "RAUMCODE",
  join: "BEITRETEN",
  roomCode: "RAUMCODE:",
  players: "SPIELER",
  dealRoles: "ROLLEN VERTEILEN",
  nextRound: "N√ÑCHSTE RUNDE AUSLOSEN",
  waiting: "WARTEN AUF DEN START...",
  guess: "FINDE DEN IMPOSTOR",
  enterName: "GIB EINEN NAMEN EIN!",
  enterRoom: "GIB DEN RAUMCODE EIN!",
  noRoom: "RAUM EXISTIERT NICHT!",
  full: "DER RAUM IST VOLL!",
  needExact: `ES M√úSSEN GENAU ${MAX_PLAYERS} SPIELER SEIN (OHNE HOST)!`,
  impostor: "üïµÔ∏è‚Äç‚ôÇÔ∏è DU BIST DER IMPOSTOR!",
  word: "üî§ WORT",
  roundStarted: "RUNDE GESTARTET!",
  myName: "DEIN NAME",
  wordMissing: "KEINE √úBERSETZUNG F√úR DAS WORT",
  category: "üìö KATEGORIE",
  startingIn: "NEUE RUNDE IN",
  revealSoon: "MACH DICH BEREIT"
}
};

function getCategoryName(catKey) {
  return (CATEGORIES[catKey] && CATEGORIES[catKey][lang]) ? CATEGORIES[catKey][lang] : (catKey || "");
}

function getWordForLang(catKey, wordKey) {
  if (!catKey || !wordKey || !WORDS[catKey] || !WORDS[catKey][wordKey]) return null;
  return WORDS[catKey][wordKey][lang] || null;
}

function allWordPairs() {
  const pairs = [];
  for (const catKey of Object.keys(WORDS)) {
    for (const wordKey of Object.keys(WORDS[catKey])) {
      pairs.push({ catKey, wordKey, id: `${catKey}:${wordKey}` });
    }
  }
  return pairs;
}

function pickUnusedWord(usedWords = []) {
  const usedSet = new Set(usedWords);
  const pool = allWordPairs().filter(p => !usedSet.has(p.id));
  const finalPool = pool.length ? pool : allWordPairs(); // reset puli je≈õli zabraknie
  return finalPool[Math.floor(Math.random() * finalPool.length)];
}

function applyLang() {
  document.documentElement.lang = lang;
  document.getElementById("title").innerText = t[lang].title;
  document.title = t[lang].title;

  document.getElementById("playerName").placeholder = t[lang].yourNamePh;
  document.getElementById("btnCreate").innerText = t[lang].create;
  document.getElementById("orText").innerText = t[lang].or;
  document.getElementById("joinCode").placeholder = t[lang].joinCodePh;
  document.getElementById("btnJoin").innerText = t[lang].join;

  document.getElementById("roomCodeLabel").innerText = t[lang].roomCode;
  document.getElementById("btnStart").innerText = t[lang].dealRoles;
  document.getElementById("btnNextRound").innerText = t[lang].nextRound;

  const waiting = document.getElementById("waiting");
  if (!waiting.classList.contains("hidden")) {
    document.getElementById("waitingText").innerText = t[lang].waiting;
  }

  if (roomRef) updatePlayerList();

  const myNameDiv = document.getElementById("myName");
  if (!myNameDiv.classList.contains("hidden")) {
    myNameDiv.innerText = `${t[lang].myName}: ${playerName}`;
  }

  refreshCurrentResult();
}

applyLang();

/* ====== HELPERS ====== */
function randomCode() { return Math.floor(1000 + Math.random() * 9000).toString(); }

function showMyName() {
  const nameDiv = document.getElementById("myName");
  nameDiv.innerText = `${t[lang].myName}: ${playerName}`;
  nameDiv.classList.remove("hidden");
}

function showResult(text) {
  document.getElementById("result").innerText = text;
  document.getElementById("result").classList.remove("hidden");

  const waitingDiv = document.getElementById("waiting");
  if (!waitingDiv.classList.contains("hidden")) {
    waitingDiv.querySelector("h2").innerText = t[lang].guess;
  }
}

function clearCountdown() {
  if (countdownTimer) {
    clearInterval(countdownTimer);
    countdownTimer = null;
  }
}

function runCountdownAndReveal(roomData) {
  clearCountdown();

  const revealAt = roomData.revealAt;
  const catKey = roomData.categoryKey;
  const wordKey = roomData.wordKey;

  const tick = () => {
    const catName = getCategoryName(catKey);
    const msLeft = Math.max(0, (revealAt || 0) - Date.now());
    const secLeft = Math.ceil(msLeft / 1000);

    // reset border na ‚Äúneutral/green‚Äù (≈ºeby nie zostawa≈Ç czerwony po impostorze)
    document.getElementById("result").style.borderColor = "rgba(35,48,65,.85)";

    // countdown 3..2..1
    if (secLeft > 0) {
      showResult(`${t[lang].category}: ${catName}\n\n${t[lang].startingIn}: ${secLeft}`);
      return;
    }

    // REVEAL
    clearCountdown();
    const role = roomData.roles && roomData.roles[playerId];

    if (role === "impostor") {
      showResult(`${t[lang].category}: ${catName}\n\n${t[lang].impostor}`);
      // czerwony akcent dla impostora
      document.getElementById("result").style.borderColor = "rgba(255,77,109,.65)";
      return;
    }

    if (role !== "host") {
      const w = getWordForLang(catKey, wordKey);
      showResult(`${t[lang].category}: ${catName}\n\n${t[lang].word}: ${w || t[lang].wordMissing}`);
      return;
    }

    // host
    showResult(`${t[lang].category}: ${catName}\n\n${t[lang].roundStarted}`);
  };

  tick();
  countdownTimer = setInterval(tick, 200);
}

async function getNonHostCount(roomData) {
  const playersObj = roomData.players || {};
  const names = Object.values(playersObj).map(p => p.name || "");
  return names.filter(n => !n.includes("(HOST)")).length;
}

async function updatePlayerList() {
  if (!roomRef) return;
  const snap = await roomRef.get();
  const data = snap.val();
  if (!data) return;

  const playersList = data.players ? Object.values(data.players).map(p => p.name) : [];
  document.getElementById("playerList").innerText = playersList.join(", ");

  const nonHostCount = playersList.filter(n => !n.includes("(HOST)")).length;
  document.getElementById("players").innerText = `${t[lang].players}: ${nonHostCount}/${MAX_PLAYERS}`;
}

function refreshCurrentResult() {
  if (!roomRef) return;
  roomRef.get().then(snap => {
    const data = snap.val();
    if (!data || !data.started || !data.roles || !data.wordKey || !data.categoryKey || !data.revealAt) return;
    runCountdownAndReveal(data);
  });
}

/* ====== Tworzenie pokoju ====== */
window.createRoom = async function() {
  playerName = document.getElementById("playerName").value.trim();
  if (!playerName) return alert(t[lang].enterName);

  playerName += " (HOST)";
  isHost = true;
  showMyName();

  const code = randomCode();
  roomRef = db.ref("rooms/" + code);

  await roomRef.set({
    players: {},
    started: false,
    round: 0,
    usedWords: []
  });

  document.getElementById("menu").classList.add("hidden");
  document.getElementById("hostPanel").classList.remove("hidden");
  document.getElementById("roomCode").innerText = code;

  const playerRef = db.ref(`rooms/${code}/players/${playerId}`);
  await playerRef.set({ name: playerName });

  roomRef.on("value", async snapshot => {
    await updatePlayerList();
    const data = snapshot.val();
    if (data && data.started && data.roles && data.wordKey && data.categoryKey && data.revealAt) {
      if (lastSeenRound !== data.round) {
        lastSeenRound = data.round;
        runCountdownAndReveal(data);
      } else {
        runCountdownAndReveal(data);
      }
    }
  });
};

/* ====== Do≈ÇƒÖczenie do pokoju ====== */
window.joinRoom = async function() {
  playerName = document.getElementById("playerName").value.trim();
  if (!playerName) return alert(t[lang].enterName);

  const code = document.getElementById("joinCode").value.trim();
  if (!code) return alert(t[lang].enterRoom);

  roomRef = db.ref("rooms/" + code);

  const snap = await roomRef.get();
  if (!snap.exists()) return alert(t[lang].noRoom);

  const data = snap.val();
  const nonHostCount = await getNonHostCount(data);

  if (nonHostCount >= MAX_PLAYERS) return alert(t[lang].full);

  const playerRef = db.ref(`rooms/${code}/players/${playerId}`);
  await playerRef.set({ name: playerName });

  showMyName();

  document.getElementById("menu").classList.add("hidden");
  document.getElementById("waiting").classList.remove("hidden");
  document.getElementById("waitingText").innerText = t[lang].waiting;

  roomRef.on("value", snapshot => {
    updatePlayerList();
    const d = snapshot.val();
    if (d && d.started && d.roles && d.wordKey && d.categoryKey && d.revealAt) {
      if (lastSeenRound !== d.round) {
        lastSeenRound = d.round;
        runCountdownAndReveal(d);
      } else {
        runCountdownAndReveal(d);
      }
    }
  });
};

/* ====== Start gry (host) ====== */
window.startGame = async function() {
  const snap = await roomRef.get();
  const data = snap.val();
  if (!data) return;

  const players = Object.keys(data.players || {})
    .filter(id => !(data.players[id].name || "").includes("(HOST)"));

  if (players.length !== MAX_PLAYERS) return alert(t[lang].needExact);

  const usedWords = data.usedWords || [];
  const chosen = pickUnusedWord(usedWords);

  const impostor = players[Math.floor(Math.random() * players.length)];
  const roles = {};
  players.forEach(p => roles[p] = (p === impostor ? "impostor" : "normal"));
  roles[playerId] = "host";

  const round = (data.round || 0) + 1;
  const revealAt = Date.now() + 3000;

  await roomRef.update({
    started: true,
    roles,
    round,
    categoryKey: chosen.catKey,
    wordKey: chosen.wordKey,
    revealAt,
    usedWords: [...usedWords, chosen.id]
  });

  document.getElementById("btnNextRound").classList.remove("hidden");
  showResult(`${t[lang].revealSoon}...`);
};

/* ====== Kolejna runda (host) ====== */
window.nextRound = async function() {
  const snap = await roomRef.get();
  const data = snap.val();
  if (!data) return;

  const players = Object.keys(data.players || {})
    .filter(id => !(data.players[id].name || "").includes("(HOST)"));

  const usedWords = data.usedWords || [];
  const chosen = pickUnusedWord(usedWords);

  const impostor = players[Math.floor(Math.random() * players.length)];
  const roles = {};
  players.forEach(p => roles[p] = (p === impostor ? "impostor" : "normal"));
  roles[playerId] = "host";

  const round = (data.round || 0) + 1;
  const revealAt = Date.now() + 3000;

  await roomRef.update({
    started: true,
    roles,
    round,
    categoryKey: chosen.catKey,
    wordKey: chosen.wordKey,
    revealAt,
    usedWords: [...usedWords, chosen.id]
  });

  document.getElementById("result").classList.add("hidden");
};

/* ====== Eventy ====== */
document.getElementById("btnCreate").addEventListener("click", createRoom);
document.getElementById("btnJoin").addEventListener("click", joinRoom);
document.getElementById("btnStart").addEventListener("click", startGame);
document.getElementById("btnNextRound").addEventListener("click", nextRound);

document.getElementById("btnLangPl").addEventListener("click", () => { lang = "pl"; applyLang(); });
document.getElementById("btnLangDe").addEventListener("click", () => { lang = "de"; applyLang(); });
</script>
</body>
</html>

