<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üïµÔ∏è‚Äç‚ôÇÔ∏è IMPOSTOR GAME</title>
<style>
body { 
  font-family: 'Segoe UI', sans-serif; 
  background: #0d1117; 
  color: #fff; 
  text-align: center; 
  margin: 0; 
  padding: 0; 
}
h1 { color: #00d26a; margin-top: 40px; font-size: 42px; }
button { background: #00d26a; color: black; border: none; border-radius: 12px; padding: 20px 40px; font-size: 20px; margin: 15px 0; cursor: pointer; width: 80%; max-width: 300px; }
button:hover { background: #00b85d; }
input { font-size: 20px; padding: 15px; border-radius: 10px; border: 1px solid #ccc; width: 80%; max-width: 300px; text-align: center; margin-bottom: 15px; }
#myName { margin-top: 20px; padding: 20px; background: #1c222b; border-radius: 15px; box-shadow: 0 0 15px rgba(0, 210, 106, 0.4); font-size: 20px; display: inline-block; }
.card { margin-top: 30px; padding: 25px 30px; background: #161b22; border-radius: 20px; display: inline-block; font-size: 26px; font-weight: bold; color: #00d26a; text-shadow: 0 0 8px rgba(0, 210, 106, 0.7); max-width: 90%; word-wrap: break-word; transition: all 0.3s ease; }
.hidden { display: none; }
#accusePanel { margin-top: 20px; padding: 20px; background: #1c222b; border-radius: 15px; display: inline-block; max-width: 90%; text-align: left; }
.accuseButton { display:block; margin: 10px 0; padding: 10px; background:#00d26a; border-radius:10px; color:black; cursor:pointer; border:none; font-size:18px; }
.accuseButton:hover { background:#00b85d; }
</style>
</head>
<body>
<h1>üïµÔ∏è‚Äç‚ôÇÔ∏è IMPOSTOR GAME</h1>

<div id="menu">
  <input id="playerName" placeholder="Twoje imiƒô" />
  <button id="btnCreate">Stw√≥rz grƒô</button>
  <p style="margin:10px 0;">lub</p>
  <input id="joinCode" placeholder="Kod pokoju" />
  <button id="btnJoin">Do≈ÇƒÖcz</button>
</div>

<div id="hostPanel" class="hidden">
  <h2>Kod pokoju: <span id="roomCode"></span></h2>
  <p id="players">Gracze: 0/4</p>
  <p id="playerList"></p>
  <button id="btnStart">Rozdaj role</button>
  <button id="btnNextRound" class="hidden">Rozlosuj kolejnƒÖ rundƒô</button>
</div>

<div id="waiting" class="hidden">
  <h2>Oczekiwanie na rozpoczƒôcie...</h2>
</div>

<div id="myName" class="hidden card"></div>
<div id="result" class="hidden card"></div>

<!-- Panel oskar≈ºania -->
<div id="accusePanel" class="hidden card">
  <h3>Oskar≈º impostora</h3>
  <div id="accuseButtons"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAy1mE_Q3fJo9W2Aa9EQUqp0L0Bn53XPHc",
  authDomain: "impostor-game-ebc12.firebaseapp.com",
  databaseURL: "https://impostor-game-ebc12-default-rtdb.europe-west1.firebasedatabase.app/",
  projectId: "impostor-game-ebc12",
  storageBucket: "impostor-game-ebc12.appspot.com",
  messagingSenderId: "561452405867",
  appId: "1:561452405867:web:24fb4cdf0320c2c3488d2e",
  measurementId: "G-DKBLTBFHJ5"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const words = ["ASTRONAUTA","PARAPET","KANIBAL","BETONIARKA","KAPSEL","HIPOPOTAM","TE≈öCIOWA","≈ªAGL√ìWKA","ANTARKTYDA","MAGNEZ","WIEWI√ìRKA","KARALUCH","PUDE≈ÅKO"];
let playerId = Math.random().toString(36).substring(2,9);
let roomRef = null;
let isHost = false;
let playerName = "";
let playersData = {};
let accusedThisRound = false;

// Funkcje UI
function showMyName(){ const nameDiv=document.getElementById("myName"); nameDiv.innerText=`Twoje imiƒô: ${playerName}`; nameDiv.classList.remove("hidden"); }
function showResult(text){ const r=document.getElementById("result"); r.innerText=text; r.classList.remove("hidden"); }
function updatePlayerListUI(){ 
  const list = Object.values(playersData).map(p=>p.name); 
  document.getElementById("playerList").innerText=list.join(", "); 
  const nonHost = list.filter(n=>!n.includes("(HOST)")); 
  document.getElementById("players").innerText=`Gracze: ${nonHost.length}/4`; 
}

// Tworzenie pokoju
async function createRoom(){
  playerName = document.getElementById("playerName").value.trim();
  if(!playerName) return alert("Podaj imiƒô!");
  playerName+=" (HOST)";
  isHost=true;
  showMyName();
  const code = Math.floor(1000 + Math.random()*9000).toString();
  roomRef = db.ref("rooms/"+code);
  await roomRef.set({players:{}, started:false});
  document.getElementById("menu").classList.add("hidden");
  document.getElementById("hostPanel").classList.remove("hidden");
  document.getElementById("roomCode").innerText=code;
  await db.ref(`rooms/${code}/players/${playerId}`).set({name:playerName});
}

// Do≈ÇƒÖczenie do pokoju
async function joinRoom(){
  playerName = document.getElementById("playerName").value.trim();
  if(!playerName) return alert("Podaj imiƒô!");
  showMyName();
  const code = document.getElementById("joinCode").value.trim();
  if(!code) return alert("Podaj kod pokoju!");
  roomRef = db.ref("rooms/"+code);
  const snap = await roomRef.get();
  if(!snap.exists()) return alert("Pok√≥j nie istnieje!");
  await db.ref(`rooms/${code}/players/${playerId}`).set({name:playerName});
  document.getElementById("menu").classList.add("hidden");
  document.getElementById("waiting").classList.remove("hidden");
}

// Rozpoczƒôcie gry (host)
async function startGame(){
  const snap = await roomRef.get();
  const data = snap.val();
  const players = Object.keys(data.players).filter(id=>!data.players[id].name.includes("(HOST)"));
  if(players.length!==4) return alert("Musi byƒá dok≈Çadnie 4 graczy (bez hosta)!");
  const word = words[Math.floor(Math.random()*words.length)];
  const impostor = players[Math.floor(Math.random()*players.length)];
  const roles = {};
  players.forEach(p=>roles[p]=p===impostor?"impostor":"normal");
  roles[playerId]="host";
  await roomRef.update({started:true, roles, word});
  document.getElementById("btnNextRound").classList.remove("hidden");
  showResult("Runda rozpoczƒôta!");
}

// Losowanie kolejnej rundy
async function nextRound(){
  const snap = await roomRef.get();
  const data = snap.val();
  const players = Object.keys(data.players).filter(id=>!data.players[id].name.includes("(HOST)"));
  const word = words[Math.floor(Math.random()*words.length)];
  const impostor = players[Math.floor(Math.random()*players.length)];
  const roles = {};
  players.forEach(p=>roles[p]=p===impostor?"impostor":"normal");
  roles[playerId]="host";
  await roomRef.update({started:true, roles, word});
  document.getElementById("result").classList.add("hidden");
  document.getElementById("accusePanel").classList.add("hidden");
  accusedThisRound=false;
}

// G≈Çosowanie / oskar≈ºanie
function setupAccusePanel(data){
  if(isHost) return; // host nie widzi panelu
  const role = data.roles[playerId];
  if(!role || role==="host") return;
  const panel = document.getElementById("accusePanel");
  panel.classList.remove("hidden");
  const container = document.getElementById("accuseButtons");
  container.innerHTML="";
  accusedThisRound=false;
  for(const id in data.players){
    if(id===playerId || data.players[id].name.includes("(HOST)")) continue;
    const btn = document.createElement("button");
    btn.classList.add("accuseButton");
    btn.innerText=data.players[id].name;
    btn.onclick=()=>startAccuseVote(id, data);
    container.appendChild(btn);
  }
}

// Funkcja rozpoczynajƒÖca g≈Çosowanie
async function startAccuseVote(accusedId, data){
  if(accusedThisRound) return;
  accusedThisRound=true;
  const voteRef = roomRef.child("votes").child(accusedId);
  await voteRef.set({[playerId]:true});
  showResult(`üïµÔ∏è‚Äç‚ôÇÔ∏è TRWA G≈ÅOSOWANIE!`);
  checkVotes(accusedId);
}

// Sprawdzanie g≈Ços√≥w
function checkVotes(accusedId){
  const votesRef = roomRef.child("votes").child(accusedId);
  votesRef.on("value", snap=>{
    const votes = snap.val() || {};
    const playerIds = Object.keys(playersData).filter(id=>!playersData[id].name.includes("(HOST)") && id!==accusedId);
    const allVoted = playerIds.every(id=>votes[id]!==undefined);
    if(!allVoted) return;
    // Sprawdzenie czy wszyscy zag≈Çosowali za
    const allYes = Object.values(votes).every(v=>v===true);
    const accusedName = playersData[accusedId].name;
    if(allYes){
      // Sprawdzenie czy trafiono impostora
      const isImpostor = (playersData[accusedId].role==="impostor");
      showResult(`‚úÖ Wszyscy zag≈Çosowali ZA! ${isImpostor ? `Gracz ${accusedName} by≈Ç impostorem!` : `Niestety, to nie by≈Ç impostor.`}`);
    } else {
      showResult(`‚ö†Ô∏è G≈Çosowanie zako≈Ñczone, ale nie wszyscy byli za.`);
    }
    // Czy≈õcimy panel
    document.getElementById("accusePanel").classList.add("hidden");
  });
}

// Nas≈Çuchiwanie zmian w pokoju
function listenRoom(){
  roomRef.on("value", snap=>{
    const data = snap.val();
    playersData = data.players || {};
    updatePlayerListUI();
    if(data.started){
      if(!isHost) setupAccusePanel(data);
      // Przechowywanie r√≥l lokalnie
      for(const id in data.roles){
        if(playersData[id]) playersData[id].role=data.roles[id];
      }
      const role = data.roles[playerId];
      if(role==="impostor") showResult("üïµÔ∏è‚Äç‚ôÇÔ∏è JESTE≈ö IMPOSTOREM!");
      else if(role!=="host") showResult(`üî§ Has≈Ço: ${data.word}`);
    }
  });
}

document.getElementById("btnCreate").addEventListener("click", async ()=>{
  await createRoom();
  listenRoom();
});
document.getElementById("btnJoin").addEventListener("click", async ()=>{
  await joinRoom();
  listenRoom();
});
document.getElementById("btnStart").addEventListener("click", startGame);
document.getElementById("btnNextRound").addEventListener("click", nextRound);
</script>
</body>
</html>
