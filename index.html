\<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title id="pageTitle">üïµÔ∏è‚Äç‚ôÇÔ∏è IMPOSTOR GAME</title>
<style>
body {
  font-family: 'Segoe UI', sans-serif;
  background: #0d1117;
  color: #fff;
  text-align: center;
  margin: 0;
  padding: 0;
}
h1 {
  color: #00d26a;
  margin-top: 40px;
  font-size: 42px;
}
button {
  background: #00d26a;
  color: black;
  border: none;
  border-radius: 12px;
  padding: 20px 40px;
  font-size: 20px;
  margin: 15px 0;
  cursor: pointer;
  width: 80%;
  max-width: 300px;
}
button:hover { background: #00b85d; }
input {
  font-size: 20px;
  padding: 15px;
  border-radius: 10px;
  border: 1px solid #ccc;
  width: 80%;
  max-width: 300px;
  text-align: center;
  margin-bottom: 15px;
}
#myName {
  margin-top: 20px;
  padding: 20px;
  background: #1c222b;
  border-radius: 15px;
  box-shadow: 0 0 15px rgba(0, 210, 106, 0.4);
  font-size: 20px;
  display: inline-block;
}
.card {
  margin-top: 30px;
  padding: 25px 30px;
  background: #161b22;
  border-radius: 20px;
  display: inline-block;
  font-size: 26px;
  font-weight: bold;
  color: #00d26a;
  text-shadow: 0 0 8px rgba(0, 210, 106, 0.7);
  max-width: 90%;
  word-wrap: break-word;
  transition: all 0.3s ease;
  white-space: pre-line; /* ≈ºeby \n dzia≈Ça≈Ço czytelnie */
}
.hidden { display: none; }
.smallBtnRow{
  display:flex;
  gap:10px;
  justify-content:center;
  flex-wrap:wrap;
  margin-bottom: 20px;
}
.smallBtnRow button{
  width:auto;
  padding: 10px 18px;
  font-size: 16px;
  margin: 0;
  max-width:none;
}
</style>
</head>
<body>

<h1 id="title">üïµÔ∏è‚Äç‚ôÇÔ∏è IMPOSTOR GAME</h1>

<!-- WYB√ìR JƒòZYKA -->
<div class="smallBtnRow">
  <button id="btnLangPl">üáµüá± Polski</button>
  <button id="btnLangDe">üá©üá™ Deutsch</button>
</div>

<div id="menu">
  <input id="playerName" placeholder="Twoje imiƒô" />
  <button id="btnCreate">Stw√≥rz grƒô</button>
  <p id="orText" style="margin:10px 0;">lub</p>
  <input id="joinCode" placeholder="Kod pokoju" />
  <button id="btnJoin">Do≈ÇƒÖcz</button>
</div>

<div id="hostPanel" class="hidden">
  <h2><span id="roomCodeLabel">Kod pokoju:</span> <span id="roomCode"></span></h2>
  <p id="players">Gracze: 0/4</p>
  <p id="playerList"></p>
  <button id="btnStart">Rozdaj role</button>
  <button id="btnNextRound" class="hidden">Rozlosuj kolejnƒÖ rundƒô</button>
</div>

<div id="waiting" class="hidden">
  <h2 id="waitingText">Oczekiwanie na rozpoczƒôcie...</h2>
</div>

<div id="myName" class="hidden card"></div>
<div id="result" class="hidden card"></div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
/* ====== USTAWIENIE: ILO≈öƒÜ GRACZY (bez hosta) ====== */
const MAX_PLAYERS = 4;

/* ====== Firebase ====== */
const firebaseConfig = {
  apiKey: "AIzaSyAy1mE_Q3fJo9W2Aa9EQUqp0L0Bn53XPHc",
  authDomain: "impostor-game-ebc12.firebaseapp.com",
  databaseURL: "https://impostor-game-ebc12-default-rtdb.europe-west1.firebasedatabase.app/",
  projectId: "impostor-game-ebc12",
  storageBucket: "impostor-game-ebc12.appspot.com",
  messagingSenderId: "561452405867",
  appId: "1:561452405867:web:24fb4cdf0320c2c3488d2e",
  measurementId: "G-DKBLTBFHJ5"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ====== KATEGORIE PL/DE ====== */
const CATEGORIES = {
  body:      { pl: "Cia≈Ço", de: "K√∂rper" },
  animals:   { pl: "Zwierzƒôta", de: "Tiere" },
  places:    { pl: "Miejsca", de: "Orte" },
  transport: { pl: "Transport", de: "Transport" },
  tech:      { pl: "Technologia", de: "Technik" },
  food:      { pl: "Jedzenie", de: "Essen" },
  drinks:    { pl: "Napoje", de: "Getr√§nke" },
  seasons:   { pl: "Pory roku", de: "Jahreszeiten" },
  weather:   { pl: "Pogoda", de: "Wetter" },
  events:    { pl: "Wydarzenia", de: "Events" },
  sport:     { pl: "Sport", de: "Sport" },
  shopping:  { pl: "Zakupy", de: "Einkaufen" },
  time:      { pl: "Czas", de: "Zeit" },
  relations: { pl: "Relacje", de: "Beziehungen" },
  school:    { pl: "Szko≈Ça", de: "Schule" },
  home:      { pl: "Dom", de: "Zuhause" },
  jobs:      { pl: "Zawody", de: "Berufe" },
  nature:    { pl: "Natura", de: "Natur" },
  sweets:    { pl: "S≈Çodycze", de: "S√º√ües" },
  music:     { pl: "Muzyka", de: "Musik" },
  social:    { pl: "Internet", de: "Internet" },
  clothes:   { pl: "Ubrania", de: "Kleidung" }
};

/* ====== HAS≈ÅA POD KATEGORIAMI PL/DE ====== */
/* (w razie potrzeby mo≈ºesz dopisaƒá kolejne s≈Çowa w odpowiednich kategoriach) */
const WORDS = {
  body: {
    oko: { pl: "OKO", de: "AUGE" },
    ucho:{ pl: "UCHO", de: "OHR" },
    nos: { pl: "NOS", de: "NASE" },
    reka:{ pl: "RƒòKA", de: "HAND" },
    noga:{ pl: "NOGA", de: "BEIN" },
  },
  animals: {
    kot: { pl: "KOT", de: "KATZE" },
    pies:{ pl: "PIES", de: "HUND" },
    ptak:{ pl: "PTAK", de: "VOGEL" },
    ryba:{ pl: "RYBA", de: "FISCH" },
    kon: { pl: "KO≈É", de: "PFERD" },
  },
  places: {
    dom:   { pl: "DOM", de: "HAUS" },
    szkola:{ pl: "SZKO≈ÅA", de: "SCHULE" },
    praca: { pl: "PRACA", de: "ARBEIT" },
    miasto:{ pl: "MIASTO", de: "STADT" },
    wies:  { pl: "WIE≈ö", de: "DORF" },
    park:  { pl: "PARK", de: "PARK" },
    las:   { pl: "LAS", de: "WALD" },
    jezioro:{ pl: "JEZIORO", de: "SEE" },
    morze:  { pl: "MORZE", de: "MEER" },
    gory:   { pl: "G√ìRY", de: "BERGE" },
  },
  transport: {
    auto:   { pl: "AUTO", de: "AUTO" },
    rower:  { pl: "ROWER", de: "FAHRRAD" },
    pociag: { pl: "POCIƒÑG", de: "ZUG" },
    autobus:{ pl: "AUTOBUS", de: "BUS" },
    tramwaj:{ pl: "TRAMWAJ", de: "STRA√üENBAHN" },
  },
  tech: {
    telefon:  { pl: "TELEFON", de: "HANDY" },
    komputer: { pl: "KOMPUTER", de: "COMPUTER" },
    internet: { pl: "INTERNET", de: "INTERNET" },
    gra:      { pl: "GRA", de: "SPIEL" },
    film:     { pl: "FILM", de: "FILM" },
  },
  food: {
    pizza:     { pl: "PIZZA", de: "PIZZA" },
    hamburger: { pl: "HAMBURGER", de: "HAMBURGER" },
    kanapka:   { pl: "KANAPKA", de: "SANDWICH" },
    makaron:   { pl: "MAKARON", de: "NUDELN" },
    zupa:      { pl: "ZUPA", de: "SUPPE" },
  },
  drinks: {
    woda:    { pl: "WODA", de: "WASSER" },
    kawa:    { pl: "KAWA", de: "KAFFEE" },
    herbata: { pl: "HERBATA", de: "TEE" },
    sok:     { pl: "SOK", de: "SAFT" },
    mleko:   { pl: "MLEKO", de: "MILCH" },
  },
  seasons: {
    lato:   { pl: "LATO", de: "SOMMER" },
    zima:   { pl: "ZIMA", de: "WINTER" },
    wiosna: { pl: "WIOSNA", de: "FR√úHLING" },
    jesien: { pl: "JESIE≈É", de: "HERBST" },
  },
  weather: {
    pogoda: { pl: "POGODA", de: "WETTER" },
    deszcz: { pl: "DESZCZ", de: "REGEN" },
    snieg:  { pl: "≈öNIEG", de: "SCHNEE" },
    wiatr:  { pl: "WIATR", de: "WIND" },
    slonce: { pl: "S≈ÅO≈ÉCE", de: "SONNE" },
    chmury: { pl: "CHMURY", de: "WOLKEN" },
  },
  events: {
    wakacje:{ pl: "WAKACJE", de: "URLAUB" },
    weekend:{ pl: "WEEKEND", de: "WOCHENENDE" },
    impreza:{ pl: "IMPREZA", de: "PARTY" },
    koncert:{ pl: "KONCERT", de: "KONZERT" },
  },
  sport: {
    sport:    { pl: "SPORT", de: "SPORT" },
    pilka:    { pl: "PI≈ÅKA", de: "BALL" },
    mecz:     { pl: "MECZ", de: "SPIEL" },
    basen:    { pl: "BASEN", de: "SCHWIMMBAD" },
    silownia: { pl: "SI≈ÅOWNIA", de: "FITNESSSTUDIO" },
    bieganie: { pl: "BIEGANIE", de: "LAUFEN" },
  },
  shopping: {
    pieniadze:{ pl: "PIENIƒÑDZE", de: "GELD" },
    sklep:    { pl: "SKLEP", de: "LADEN" },
    zakupy:   { pl: "ZAKUPY", de: "EINKAUF" },
    prezent:  { pl: "PREZENT", de: "GESCHENK" },
    promocja: { pl: "PROMOCJA", de: "ANGEBOT" },
  },
  time: {
    czas:   { pl: "CZAS", de: "ZEIT" },
    dzien:  { pl: "DZIE≈É", de: "TAG" },
    noc:    { pl: "NOC", de: "NACHT" },
    rano:   { pl: "RANO", de: "MORGEN" },
    wieczor:{ pl: "WIECZ√ìR", de: "ABEND" },
  },
  relations: {
    milosc:   { pl: "MI≈ÅO≈öƒÜ", de: "LIEBE" },
    przyjazn: { pl: "PRZYJA≈π≈É", de: "FREUNDSCHAFT" },
    rodzina:  { pl: "RODZINA", de: "FAMILIE" },
    dziecko:  { pl: "DZIECKO", de: "KIND" },
    rodzice:  { pl: "RODZICE", de: "ELTERN" },
  },
  school: {
    nauczyciel:{ pl: "NAUCZYCIEL", de: "LEHRER" },
    uczen:     { pl: "UCZE≈É", de: "SCH√úLER" },
    ksiazka:   { pl: "KSIƒÑ≈ªKA", de: "BUCH" },
    zeszyt:    { pl: "ZESZYT", de: "HEFT" },
    dlugopis:  { pl: "D≈ÅUGOPIS", de: "KUGELSCHREIBER" },
  },
  home: {
    stol:    { pl: "ST√ì≈Å", de: "TISCH" },
    krzeslo: { pl: "KRZES≈ÅO", de: "STUHL" },
    lozko:   { pl: "≈Å√ì≈ªKO", de: "BETT" },
    okno:    { pl: "OKNO", de: "FENSTER" },
    drzwi:   { pl: "DRZWI", de: "T√úR" },
    kuchnia: { pl: "KUCHNIA", de: "K√úCHE" },
    lazienka:{ pl: "≈ÅAZIENKA", de: "BADEZIMMER" },
    pokoj:   { pl: "POK√ìJ", de: "ZIMMER" },
    ogrod:   { pl: "OGR√ìD", de: "GARTEN" },
    balkon:  { pl: "BALKON", de: "BALKON" },
  },
  jobs: {
    policja:     { pl: "POLICJA", de: "POLIZEI" },
    lekarz:      { pl: "LEKARZ", de: "ARZT" },
    pielegniarka:{ pl:"PIELƒòGNIARKA", de:"KRANKENSCHWESTER" },
    strazak:     { pl: "STRA≈ªAK", de: "FEUERWEHRMANN" },
    mechanik:    { pl: "MECHANIK", de: "MECHANIKER" },
  },
  sweets: {
    lod:      { pl: "L√ìD", de: "EIS" },
    lody:     { pl: "LODY", de: "EISCREME" },
    ciasto:   { pl: "CIASTO", de: "KUCHEN" },
    czekolada:{ pl: "CZEKOLADA", de: "SCHOKOLADE" },
    cukier:   { pl: "CUKIER", de: "ZUCKER" },
  },
  music: {
    muzyka:  { pl: "MUZYKA", de: "MUSIK" },
    gitara:  { pl: "GITARA", de: "GITARRE" },
    pianino: { pl: "PIANINO", de: "KLAVIER" },
    taniec:  { pl: "TANIEC", de: "TANZ" },
    piosenka:{ pl: "PIOSENKA", de: "LIED" },
  },
  social: {
    facebook:{ pl: "FACEBOOK", de: "FACEBOOK" },
    youtube: { pl: "YOUTUBE", de: "YOUTUBE" },
    discord: { pl: "DISCORD", de: "DISCORD" },
    mem:     { pl: "MEM", de: "MEME" },
    netflix: { pl: "NETFLIX", de: "NETFLIX" },
  },
  clothes: {
    ubranie:{ pl: "UBRANIE", de: "KLEIDUNG" },
    buty:   { pl: "BUTY", de: "SCHUHE" },
    czapka: { pl: "CZAPKA", de: "M√úTZE" },
    kurtka: { pl: "KURTKA", de: "JACKE" },
    plecak: { pl: "PLECAK", de: "RUCKSACK" },
  }
};

/* ====== STAN GRY ====== */
let playerId = Math.random().toString(36).substring(2,9);
let roomRef = null;
let isHost = false;
let playerName = "";

// do kontroli rund i countdownu
let lastSeenRound = null;
let countdownTimer = null;

/* ====== T≈ÅUMACZENIA UI ====== */
let lang = "pl";
const t = {
  pl: {
    title: "üïµÔ∏è‚Äç‚ôÇÔ∏è IMPOSTOR GAME",
    yourNamePh: "Twoje imiƒô",
    create: "Stw√≥rz grƒô",
    or: "lub",
    joinCodePh: "Kod pokoju",
    join: "Do≈ÇƒÖcz",
    roomCode: "Kod pokoju:",
    players: "Gracze",
    dealRoles: "Rozdaj role",
    nextRound: "Rozlosuj kolejnƒÖ rundƒô",
    waiting: "Oczekiwanie na rozpoczƒôcie...",
    guess: "ZGADNIJ IMPOSTORA",
    enterName: "Podaj imiƒô!",
    enterRoom: "Podaj kod pokoju!",
    noRoom: "Pok√≥j nie istnieje!",
    full: "Pok√≥j jest pe≈Çny!",
    needExact: `Musi byƒá dok≈Çadnie ${MAX_PLAYERS} graczy (bez hosta)!`,
    impostor: "üïµÔ∏è‚Äç‚ôÇÔ∏è JESTE≈ö IMPOSTOREM!",
    word: "üî§ Has≈Ço",
    roundStarted: "Runda rozpoczƒôta!",
    myName: "Twoje imiƒô",
    wordMissing: "Brak t≈Çumaczenia has≈Ça",
    category: "üìö Kategoria",
    startingIn: "Nowa runda za",
    revealSoon: "Szykuj siƒô"
  },
  de: {
    title: "üïµÔ∏è‚Äç‚ôÇÔ∏è IMPOSTOR SPIEL",
    yourNamePh: "Dein Name",
    create: "Spiel erstellen",
    or: "oder",
    joinCodePh: "Raumcode",
    join: "Beitreten",
    roomCode: "Raumcode:",
    players: "Spieler",
    dealRoles: "Rollen verteilen",
    nextRound: "N√§chste Runde auslosen",
    waiting: "Warten auf den Start...",
    guess: "FINDE DEN IMPOSTOR",
    enterName: "Gib einen Namen ein!",
    enterRoom: "Gib den Raumcode ein!",
    noRoom: "Raum existiert nicht!",
    full: "Der Raum ist voll!",
    needExact: `Es m√ºssen genau ${MAX_PLAYERS} Spieler sein (ohne Host)!`,
    impostor: "üïµÔ∏è‚Äç‚ôÇÔ∏è DU BIST DER IMPOSTOR!",
    word: "üî§ Wort",
    roundStarted: "Runde gestartet!",
    myName: "Dein Name",
    wordMissing: "Keine √úbersetzung f√ºr das Wort",
    category: "üìö Kategorie",
    startingIn: "Neue Runde in",
    revealSoon: "Mach dich bereit"
  }
};

function getCategoryName(catKey) {
  return (CATEGORIES[catKey] && CATEGORIES[catKey][lang]) ? CATEGORIES[catKey][lang] : (catKey || "");
}

function getWordForLang(catKey, wordKey) {
  if (!catKey || !wordKey || !WORDS[catKey] || !WORDS[catKey][wordKey]) return null;
  return WORDS[catKey][wordKey][lang] || null;
}

function allWordPairs() {
  const pairs = [];
  for (const catKey of Object.keys(WORDS)) {
    for (const wordKey of Object.keys(WORDS[catKey])) {
      pairs.push({ catKey, wordKey, id: `${catKey}:${wordKey}` });
    }
  }
  return pairs;
}

function pickUnusedWord(usedWords = []) {
  const usedSet = new Set(usedWords);
  const pool = allWordPairs().filter(p => !usedSet.has(p.id));
  const finalPool = pool.length ? pool : allWordPairs(); // jak siƒô sko≈ÑczƒÖ ‚Äî reset puli, ≈ºeby nie zablokowaƒá gry
  return finalPool[Math.floor(Math.random() * finalPool.length)];
}

function applyLang() {
  document.documentElement.lang = lang;
  document.getElementById("title").innerText = t[lang].title;
  document.title = t[lang].title;

  document.getElementById("playerName").placeholder = t[lang].yourNamePh;
  document.getElementById("btnCreate").innerText = t[lang].create;
  document.getElementById("orText").innerText = t[lang].or;
  document.getElementById("joinCode").placeholder = t[lang].joinCodePh;
  document.getElementById("btnJoin").innerText = t[lang].join;

  document.getElementById("roomCodeLabel").innerText = t[lang].roomCode;
  document.getElementById("btnStart").innerText = t[lang].dealRoles;
  document.getElementById("btnNextRound").innerText = t[lang].nextRound;

  // je≈õli kto≈õ czeka
  const waiting = document.getElementById("waiting");
  if (!waiting.classList.contains("hidden")) {
    document.getElementById("waitingText").innerText = t[lang].waiting;
  }

  // od≈õwie≈º licznik graczy
  if (roomRef) updatePlayerList();

  // od≈õwie≈º "Twoje imiƒô"
  const myNameDiv = document.getElementById("myName");
  if (!myNameDiv.classList.contains("hidden")) {
    myNameDiv.innerText = `${t[lang].myName}: ${playerName}`;
  }

  // wa≈ºne: po zmianie jƒôzyka od≈õwie≈º aktualny stan (kategoria + countdown + has≈Ço) w nowym jƒôzyku
  refreshCurrentResult();
}

applyLang();

/* ====== HELPERS ====== */
function randomCode() { return Math.floor(1000 + Math.random() * 9000).toString(); }

function showMyName() {
  const nameDiv = document.getElementById("myName");
  nameDiv.innerText = `${t[lang].myName}: ${playerName}`;
  nameDiv.classList.remove("hidden");
}

function showResult(text) {
  document.getElementById("result").innerText = text;
  document.getElementById("result").classList.remove("hidden");

  const waitingDiv = document.getElementById("waiting");
  if (!waitingDiv.classList.contains("hidden")) {
    waitingDiv.querySelector("h2").innerText = t[lang].guess;
  }
}

function clearCountdown() {
  if (countdownTimer) {
    clearInterval(countdownTimer);
    countdownTimer = null;
  }
}

function runCountdownAndReveal(roomData) {
  clearCountdown();

  const revealAt = roomData.revealAt;
  const catKey = roomData.categoryKey;
  const wordKey = roomData.wordKey;

  const tick = () => {
    const catName = getCategoryName(catKey);
    const msLeft = Math.max(0, (revealAt || 0) - Date.now());
    const secLeft = Math.ceil(msLeft / 1000);

    // countdown 3..2..1
    if (secLeft > 0) {
      showResult(`${t[lang].category}: ${catName}\n\n${t[lang].startingIn}: ${secLeft}`);
      return;
    }

    // REVEAL
    clearCountdown();
    const role = roomData.roles && roomData.roles[playerId];

    if (role === "impostor") {
      showResult(`${t[lang].category}: ${catName}\n\n${t[lang].impostor}`);
      return;
    }

    if (role !== "host") {
      const w = getWordForLang(catKey, wordKey);
      showResult(`${t[lang].category}: ${catName}\n\n${t[lang].word}: ${w || t[lang].wordMissing}`);
      return;
    }

    // host
    showResult(`${t[lang].category}: ${catName}\n\n${t[lang].roundStarted}`);
  };

  tick();
  countdownTimer = setInterval(tick, 200);
}

async function getNonHostCount(roomData) {
  const playersObj = roomData.players || {};
  const names = Object.values(playersObj).map(p => p.name || "");
  return names.filter(n => !n.includes("(HOST)")).length;
}

async function updatePlayerList() {
  if (!roomRef) return;
  const snap = await roomRef.get();
  const data = snap.val();
  if (!data) return;

  const playersList = data.players ? Object.values(data.players).map(p => p.name) : [];
  document.getElementById("playerList").innerText = playersList.join(", ");

  const nonHostCount = playersList.filter(n => !n.includes("(HOST)")).length;
  document.getElementById("players").innerText = `${t[lang].players}: ${nonHostCount}/${MAX_PLAYERS}`;
}

function refreshCurrentResult() {
  if (!roomRef) return;
  roomRef.get().then(snap => {
    const data = snap.val();
    if (!data || !data.started || !data.roles || !data.wordKey || !data.categoryKey || !data.revealAt) return;

    // przelicz w nowym jƒôzyku (kategoria + countdown / has≈Ço)
    runCountdownAndReveal(data);
  });
}

/* ====== Tworzenie pokoju ====== */
window.createRoom = async function() {
  playerName = document.getElementById("playerName").value.trim();
  if (!playerName) return alert(t[lang].enterName);

  playerName += " (HOST)";
  isHost = true;
  showMyName();

  const code = randomCode();
  roomRef = db.ref("rooms/" + code);

  await roomRef.set({
    players: {},
    started: false,
    round: 0,
    usedWords: [] // <‚Äî historia hase≈Ç w pokoju
  });

  document.getElementById("menu").classList.add("hidden");
  document.getElementById("hostPanel").classList.remove("hidden");
  document.getElementById("roomCode").innerText = code;

  const playerRef = db.ref(`rooms/${code}/players/${playerId}`);
  await playerRef.set({ name: playerName });

  roomRef.on("value", async snapshot => {
    await updatePlayerList();
    const data = snapshot.val();
    if (data && data.started && data.roles && data.wordKey && data.categoryKey && data.revealAt) {
      if (lastSeenRound !== data.round) {
        lastSeenRound = data.round;
        runCountdownAndReveal(data);
      } else {
        // je≈õli jƒôzyk zmieniony lub kto≈õ do≈ÇƒÖczy≈Ç p√≥≈∫niej ‚Äî od≈õwie≈º ekran (bez restartu rundy)
        runCountdownAndReveal(data);
      }
    }
  });
};

/* ====== Do≈ÇƒÖczenie do pokoju ====== */
window.joinRoom = async function() {
  playerName = document.getElementById("playerName").value.trim();
  if (!playerName) return alert(t[lang].enterName);

  const code = document.getElementById("joinCode").value.trim();
  if (!code) return alert(t[lang].enterRoom);

  roomRef = db.ref("rooms/" + code);

  const snap = await roomRef.get();
  if (!snap.exists()) return alert(t[lang].noRoom);

  const data = snap.val();
  const nonHostCount = await getNonHostCount(data);

  if (nonHostCount >= MAX_PLAYERS) return alert(t[lang].full);

  const playerRef = db.ref(`rooms/${code}/players/${playerId}`);
  await playerRef.set({ name: playerName });

  showMyName();

  document.getElementById("menu").classList.add("hidden");
  document.getElementById("waiting").classList.remove("hidden");
  document.getElementById("waitingText").innerText = t[lang].waiting;

  roomRef.on("value", snapshot => {
    updatePlayerList();
    const d = snapshot.val();
    if (d && d.started && d.roles && d.wordKey && d.categoryKey && d.revealAt) {
      if (lastSeenRound !== d.round) {
        lastSeenRound = d.round;
        runCountdownAndReveal(d);
      } else {
        runCountdownAndReveal(d);
      }
    }
  });
};

/* ====== Start gry (host) ====== */
window.startGame = async function() {
  const snap = await roomRef.get();
  const data = snap.val();
  if (!data) return;

  const players = Object.keys(data.players || {})
    .filter(id => !(data.players[id].name || "").includes("(HOST)"));

  if (players.length !== MAX_PLAYERS) return alert(t[lang].needExact);

  const usedWords = data.usedWords || [];
  const chosen = pickUnusedWord(usedWords); // {catKey, wordKey, id}

  const impostor = players[Math.floor(Math.random() * players.length)];
  const roles = {};
  players.forEach(p => roles[p] = (p === impostor ? "impostor" : "normal"));
  roles[playerId] = "host";

  const round = (data.round || 0) + 1;
  const revealAt = Date.now() + 3000; // 3 sekundy => 3..2..1

  await roomRef.update({
    started: true,
    roles,
    round,
    categoryKey: chosen.catKey,
    wordKey: chosen.wordKey,
    revealAt,
    usedWords: [...usedWords, chosen.id]
  });

  document.getElementById("btnNextRound").classList.remove("hidden");
  showResult(`${t[lang].revealSoon}...`);
};

/* ====== Kolejna runda (host) ====== */
window.nextRound = async function() {
  const snap = await roomRef.get();
  const data = snap.val();
  if (!data) return;

  const players = Object.keys(data.players || {})
    .filter(id => !(data.players[id].name || "").includes("(HOST)"));

  const usedWords = data.usedWords || [];
  const chosen = pickUnusedWord(usedWords);

  const impostor = players[Math.floor(Math.random() * players.length)];
  const roles = {};
  players.forEach(p => roles[p] = (p === impostor ? "impostor" : "normal"));
  roles[playerId] = "host";

  const round = (data.round || 0) + 1;
  const revealAt = Date.now() + 3000;

  await roomRef.update({
    started: true,
    roles,
    round,
    categoryKey: chosen.catKey,
    wordKey: chosen.wordKey,
    revealAt,
    usedWords: [...usedWords, chosen.id]
  });

  document.getElementById("result").classList.add("hidden");
};

/* ====== Eventy ====== */
document.getElementById("btnCreate").addEventListener("click", createRoom);
document.getElementById("btnJoin").addEventListener("click", joinRoom);
document.getElementById("btnStart").addEventListener("click", startGame);
document.getElementById("btnNextRound").addEventListener("click", nextRound);

document.getElementById("btnLangPl").addEventListener("click", () => { lang = "pl"; applyLang(); });
document.getElementById("btnLangDe").addEventListener("click", () => { lang = "de"; applyLang(); });
</script>
</body>
</html>
