<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>üïµÔ∏è‚Äç‚ôÇÔ∏è IMPOSTOR GAME</title>
<style>
body { 
  font-family: 'Segoe UI', sans-serif; 
  background: #0d1117; 
  color: #fff; 
  text-align: center; 
  margin: 0; 
  padding: 0; 
}
h1 { 
  color: #00d26a; 
  margin-top: 40px; 
  font-size: 42px; 
}
button { 
  background: #00d26a; 
  color: black; 
  border: none; 
  border-radius: 12px; 
  padding: 20px 40px; 
  font-size: 20px; 
  margin: 15px 0; 
  cursor: pointer; 
  width: 80%; 
  max-width: 300px; 
}
button:hover { background: #00b85d; }
input { 
  font-size: 20px; 
  padding: 15px; 
  border-radius: 10px; 
  border: 1px solid #ccc; 
  width: 80%; 
  max-width: 300px; 
  text-align: center; 
  margin-bottom: 15px; 
}
#myName {
  margin-top: 20px;
  padding: 20px;
  background: #1c222b;
  border-radius: 15px;
  box-shadow: 0 0 15px rgba(0, 210, 106, 0.4);
  font-size: 20px;
  display: inline-block;
}
.card { 
  margin-top: 30px; 
  padding: 25px 30px; 
  background: #161b22; 
  border-radius: 20px; 
  display: inline-block; 
  font-size: 26px; 
  font-weight: bold; 
  color: #00d26a;
  text-shadow: 0 0 8px rgba(0, 210, 106, 0.7);
  max-width: 90%; 
  word-wrap: break-word; 
  transition: all 0.3s ease;
}
.hidden { display: none; }

/* --- Panel g≈Çosowania --- */
#votePanel {
  margin-top: 30px;
  padding: 20px;
  background: #1c222b;
  border-radius: 15px;
  box-shadow: 0 0 10px rgba(0,210,106,0.3);
  display: inline-block;
}
.voteBtn {
  display: block;
  background: #00d26a;
  color: black;
  border: none;
  border-radius: 10px;
  padding: 12px;
  margin: 10px auto;
  width: 80%;
  max-width: 250px;
  font-size: 18px;
  cursor: pointer;
}
.voteBtn:hover { background: #00b85d; }

/* --- Panel impostora --- */
#impostorGuessPanel {
  margin-top: 30px;
  padding: 20px;
  background: #1c222b;
  border-radius: 15px;
  box-shadow: 0 0 10px rgba(255, 0, 0, 0.3);
  display: inline-block;
}
#impostorGuess {
  font-size: 18px;
  padding: 10px;
  width: 80%;
  border-radius: 8px;
  border: 1px solid #ccc;
  text-align: center;
  margin-bottom: 10px;
}
#btnGuessWord {
  background: #ff4444;
  color: white;
  border: none;
  border-radius: 10px;
  padding: 12px 20px;
  cursor: pointer;
  font-size: 18px;
}
#btnGuessWord:hover { background: #e63c3c; }
</style>
</head>
<body>
<h1>üïµÔ∏è‚Äç‚ôÇÔ∏è IMPOSTOR GAME</h1>

<div id="menu">
  <input id="playerName" placeholder="Twoje imiƒô" />
  <button id="btnCreate">Stw√≥rz grƒô</button>
  <p style="margin:10px 0;">lub</p>
  <input id="joinCode" placeholder="Kod pokoju" />
  <button id="btnJoin">Do≈ÇƒÖcz</button>
</div>

<div id="hostPanel" class="hidden">
  <h2>Kod pokoju: <span id="roomCode"></span></h2>
  <p id="players">Gracze: 0/6</p>
  <p id="playerList"></p>
  <button id="btnStart">Rozdaj role</button>
  <button id="btnNextRound" class="hidden">Rozlosuj kolejnƒÖ rundƒô</button>
</div>

<div id="waiting" class="hidden">
  <h2>Oczekiwanie na rozpoczƒôcie...</h2>
</div>

<div id="myName" class="hidden card"></div>
<div id="result" class="hidden card"></div>

<!-- Panel g≈Çosowania -->
<div id="votePanel" class="hidden">
  <h2>Wybierz, kto jest impostorem:</h2>
  <div id="voteList"></div>
  <div id="voteConfirm" class="hidden">
    <p id="voteTargetText"></p>
    <button id="btnConfirmVote">‚úÖ POTWIERD≈π WYB√ìR</button>
    <button id="btnCancelVote">‚Ü©Ô∏è COFNIJ</button>
  </div>
</div>

<!-- Panel dla impostora -->
<div id="impostorGuessPanel" class="hidden">
  <h2>Spr√≥buj odgadnƒÖƒá has≈Ço!</h2>
  <input id="impostorGuess" placeholder="Wpisz has≈Ço..." />
  <button id="btnGuessWord">ZATWIERD≈π HAS≈ÅO</button>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAy1mE_Q3fJo9W2Aa9EQUqp0L0Bn53XPHc",
  authDomain: "impostor-game-ebc12.firebaseapp.com",
  databaseURL: "https://impostor-game-ebc12-default-rtdb.europe-west1.firebasedatabase.app/",
  projectId: "impostor-game-ebc12",
  storageBucket: "impostor-game-ebc12.appspot.com",
  messagingSenderId: "561452405867",
  appId: "1:561452405867:web:24fb4cdf0320c2c3488d2e",
  measurementId: "G-DKBLTBFHJ5"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const MAX_PLAYERS = 6;

let playerId = Math.random().toString(36).substring(2,9);
let roomRef = null;
let isHost = false;
let playerName = "";
let selectedVote = null;
let hasVoted = false;
let totalPlayers = 0;

function randomCode() { return Math.floor(1000 + Math.random() * 9000).toString(); }
function showMyName() {
  const nameDiv = document.getElementById("myName");
  nameDiv.innerText = `Twoje imiƒô: ${playerName}`;
  nameDiv.classList.remove("hidden");
}
function showResult(text) {
  document.getElementById("result").innerText = text;
  document.getElementById("result").classList.remove("hidden");
}
async function updatePlayerList() {
  const snap = await roomRef.get();
  const data = snap.val();
  const playersList = data.players ? Object.values(data.players).map(p => p.name) : [];
  document.getElementById("playerList").innerText = playersList.join(", ");
  const nonHostCount = playersList.filter(n => !n.includes("(HOST)")).length;
  document.getElementById("players").innerText = `Gracze: ${nonHostCount}/${MAX_PLAYERS}`;
}

/* --- Tworzenie pokoju --- */
window.createRoom = async function() {
  playerName = document.getElementById("playerName").value.trim();
  if (!playerName) return alert("Podaj imiƒô!");
  playerName += " (HOST)";
  isHost = true;
  showMyName();
  const code = randomCode();
  roomRef = db.ref("rooms/" + code);
  await roomRef.set({ players: {}, started: false, scores: {} });
  document.getElementById("menu").classList.add("hidden");
  document.getElementById("hostPanel").classList.remove("hidden");
  document.getElementById("roomCode").innerText = code;
  await db.ref(`rooms/${code}/players/${playerId}`).set({ name: playerName });
  roomRef.on("value", snapshot => {
    updatePlayerList();
    const data = snapshot.val();
    if (data.started && data.roles && data.word) handleGameData(data);
  });
}

/* --- Do≈ÇƒÖczanie --- */
window.joinRoom = async function() {
  playerName = document.getElementById("playerName").value.trim();
  if (!playerName) return alert("Podaj imiƒô!");
  showMyName();
  const code = document.getElementById("joinCode").value.trim();
  if (!code) return alert("Podaj kod pokoju!");
  roomRef = db.ref("rooms/" + code);
  const snapshot = await roomRef.get();
  if (!snapshot.exists()) return alert("Pok√≥j nie istnieje!");
  await db.ref(`rooms/${code}/players/${playerId}`).set({ name: playerName });
  document.getElementById("menu").classList.add("hidden");
  document.getElementById("waiting").classList.remove("hidden");
  roomRef.on("value", snapshot => {
    updatePlayerList();
    const data = snapshot.val();
    if (data.started && data.roles && data.word) handleGameData(data);
  });
}

/* --- Start gry --- */
window.startGame = async function() {
  const snap = await roomRef.get();
  const data = snap.val();
  const players = Object.keys(data.players || {}).filter(id => !data.players[id].name.includes("(HOST)"));
  if (players.length !== MAX_PLAYERS) return alert(`Musi byƒá dok≈Çadnie ${MAX_PLAYERS} graczy (bez hosta)!`);
  const words = ["ASTRONAUTA","PARAPET","KANIBAL","BETONIARKA","KAPSEL","HIPOPOTAM","TE≈öCIOWA","≈ªAGL√ìWKA","MAGNES","TELEFON","KOMPUTER","FRYZURA","PIES","KOT"];
  const word = words[Math.floor(Math.random() * words.length)];
  const impostor = players[Math.floor(Math.random() * players.length)];
  const roles = {};
  players.forEach(p => roles[p] = p === impostor ? "impostor" : "normal");
  roles[playerId] = "host";
  await roomRef.update({ started: true, roles, word, votes: {}, roundEnded: false });
  document.getElementById("btnNextRound").classList.remove("hidden");
  showResult("Runda rozpoczƒôta!");
}

/* --- Kolejna runda --- */
window.nextRound = async function() {
  const snap = await roomRef.get();
  const data = snap.val();
  const players = Object.keys(data.players || {}).filter(id => !data.players[id].name.includes("(HOST)"));
  const words = ["ASTRONAUTA","PARAPET","KANIBAL","BETONIARKA","KAPSEL","HIPOPOTAM","TE≈öCIOWA","≈ªAGL√ìWKA","MAGNES","TELEFON","KOMPUTER","FRYZURA","PIES","KOT"];
  const word = words[Math.floor(Math.random() * words.length)];
  const impostor = players[Math.floor(Math.random() * players.length)];
  const roles = {};
  players.forEach(p => roles[p] = p === impostor ? "impostor" : "normal");
  roles[playerId] = "host";
  await roomRef.update({ started: true, roles, word, votes: {}, roundEnded: false });
  document.getElementById("result").classList.add("hidden");
}

/* --- G≈Ç√≥wna logika gry po rozpoczƒôciu --- */
function handleGameData(data) {
  const role = data.roles[playerId];
  const word = data.word;
  if (role === "impostor") {
    showResult("üïµÔ∏è‚Äç‚ôÇÔ∏è JESTE≈ö IMPOSTOREM!");
    document.getElementById("impostorGuessPanel").classList.remove("hidden");
  } else if (role !== "host") {
    showResult(`üî§ Has≈Ço: ${word}`);
    const allPlayers = Object.values(data.players || {});
    setTimeout(() => showVotePanel(allPlayers), 2000);
  }
  if (data.roundEnded) endRound(data);
}

/* --- Panel g≈Çosowania --- */
function showVotePanel(players) {
  const votePanel = document.getElementById("votePanel");
  const voteList = document.getElementById("voteList");
  const voteConfirm = document.getElementById("voteConfirm");
  voteList.innerHTML = "";
  votePanel.classList.remove("hidden");
  voteConfirm.classList.add("hidden");
  hasVoted = false;
  players.forEach(p => {
    if (p.name.includes("(HOST)") || p.name === playerName) return;
    const btn = document.createElement("button");
    btn.innerText = p.name;
    btn.className = "voteBtn";
    btn.onclick = () => selectVote(p.name);
    voteList.appendChild(btn);
  });
}
function selectVote(name) {
  selectedVote = name;
  document.getElementById("voteList").classList.add("hidden");
  document.getElementById("voteConfirm").classList.remove("hidden");
  document.getElementById("voteTargetText").innerText = `Czy potwierdzasz g≈Ços na: ${name}?`;
}
function cancelVote() {
  selectedVote = null;
  document.getElementById("voteConfirm").classList.add("hidden");
  document.getElementById("voteList").classList.remove("hidden");
}
async function confirmVote() {
  if (!selectedVote || hasVoted) return;
  hasVoted = true;
  const code = document.getElementById("roomCode").innerText || document.getElementById("joinCode").value;
  await db.ref(`rooms/${code}/votes/${playerId}`).set(selectedVote);
  document.getElementById("votePanel").innerHTML = `<h2>Dziƒôkujemy!</h2><p>Odda≈Çe≈õ g≈Ços na: <b>${selectedVote}</b></p>`;
  const snap = await roomRef.get();
  const data = snap.val();
  const votes = data.votes || {};
  const players = Object.keys(data.players || {}).filter(p => !data.players[p].name.includes("(HOST)"));
  if (Object.keys(votes).length === players.length) endRound(data);
}
document.getElementById("btnConfirmVote").addEventListener("click", confirmVote);
document.getElementById("btnCancelVote").addEventListener("click", cancelVote);

/* --- Zako≈Ñczenie rundy i punktacja --- */
async function endRound(data) {
  if (data.roundEnded) return;
  const votes = data.votes || {};
  const roles = data.roles || {};
  const impostorEntry = Object.entries(roles).find(([id, r]) => r === "impostor");
  if (!impostorEntry) return;
  const impostorId = impostorEntry[0];
  const impostorName = data.players[impostorId].name;
  const scores = data.scores || {};
  for (const [pid, target] of Object.entries(votes)) {
    if (!scores[pid]) scores[pid] = 0;
    if (target === impostorName) scores[pid] += 1;
  }
  await roomRef.update({ scores, roundEnded: true });
  const myVote = votes[playerId];
  if (myVote) {
    if (myVote === impostorName) showResult("üéâ GRATULACJE! Zgad≈Çe≈õ impostora!");
    else showResult("üòî POMY≈ÅKA! Ten gracz nie by≈Ç impostorem.");
  }
}

/* --- Impostor zgaduje has≈Ço --- */
document.getElementById("btnGuessWord").addEventListener("click", async () => {
  const guess = document.getElementById("impostorGuess").value.trim();
  if (!guess) return alert("Wpisz has≈Ço!");
  const snap = await roomRef.get();
  const data = snap.val();
  const word = data.word;
  if (guess.toLowerCase() === word.toLowerCase()) {
    await roomRef.update({ roundEnded: true });
    showResult("üéØ IMPOSOTOR ODGAD≈Å HAS≈ÅO! KONIEC RUNDY!");
  } else {
    alert("Niepoprawne has≈Ço!");
  }
});

document.getElementById("btnCreate").addEventListener("click", createRoom);
document.getElementById("btnJoin").
