<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>üïµÔ∏è‚Äç‚ôÇÔ∏è IMPOSTOR GAME</title>
<style>
body { 
  font-family: 'Segoe UI', sans-serif; 
  background: #0d1117; 
  color: #fff; 
  text-align: center; 
  margin: 0; 
  padding: 0; 
}
h1 { 
  color: #00d26a; 
  margin-top: 40px; 
  font-size: 42px; 
}
button { 
  background: #00d26a; 
  color: black; 
  border: none; 
  border-radius: 12px; 
  padding: 15px 30px; 
  font-size: 18px; 
  margin: 10px 0; 
  cursor: pointer; 
  width: 80%; 
  max-width: 300px; 
}
button:hover { background: #00b85d; }
input { 
  font-size: 18px; 
  padding: 12px; 
  border-radius: 10px; 
  border: 1px solid #ccc; 
  width: 80%; 
  max-width: 300px; 
  text-align: center; 
  margin-bottom: 10px; 
}
#myName, #result, #votePanel { 
  margin-top: 20px; 
  padding: 15px; 
  background: #1c222b; 
  border-radius: 15px; 
  box-shadow: 0 0 10px rgba(0, 210, 106, 0.4); 
  font-size: 18px; 
  display: inline-block; 
  max-width: 90%; 
}
.hidden { display: none; }
.vote-button { margin: 5px; padding: 10px 20px; }
</style>
</head>
<body>
<h1>üïµÔ∏è‚Äç‚ôÇÔ∏è IMPOSTOR GAME</h1>

<div id="menu">
  <input id="playerName" placeholder="Twoje imiƒô" />
  <button id="btnCreate">Stw√≥rz grƒô</button>
  <p>lub</p>
  <input id="joinCode" placeholder="Kod pokoju" />
  <button id="btnJoin">Do≈ÇƒÖcz</button>
</div>

<div id="hostPanel" class="hidden">
  <h2>Kod pokoju: <span id="roomCode"></span></h2>
  <p id="players">Gracze: 0/4</p>
  <p id="playerList"></p>
  <button id="btnStart">Rozdaj role</button>
  <button id="btnNextRound" class="hidden">Rozlosuj kolejnƒÖ rundƒô</button>
</div>

<div id="waiting" class="hidden">
  <h2>Oczekiwanie na rozpoczƒôcie...</h2>
</div>

<div id="myName" class="hidden"></div>
<div id="result" class="hidden"></div>

<!-- Panel g≈Çosowania -->
<div id="votePanel" class="hidden">
  <h3>üó≥Ô∏è OSKAR≈ª IMPOSTORA</h3>
  <div id="voteButtons"></div>
  <p id="voteStatus"></p>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyAy1mE_Q3fJo9W2Aa9EQUqp0L0Bn53XPHc",
  authDomain: "impostor-game-ebc12.firebaseapp.com",
  databaseURL: "https://impostor-game-ebc12-default-rtdb.europe-west1.firebasedatabase.app/",
  projectId: "impostor-game-ebc12",
  storageBucket: "impostor-game-ebc12.appspot.com",
  messagingSenderId: "561452405867",
  appId: "1:561452405867:web:24fb4cdf0320c2c3488d2e",
  measurementId: "G-DKBLTBFHJ5"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const words = ["ASTRONAUTA","PARAPET","KANIBAL","BETONIARKA","KAPSEL","HIPOPOTAM","TE≈öCIOWA",
"≈ªAGL√ìWKA","ANTARKTYDA","MAGNEZ","WIEWI√ìRKA","KARALUCH","PUDE≈ÅKO","APOKALIPSA",
"CHMURKA","KREDENS","WIRUS","LAWENDA","KSEROKOPIARKA","≈ªYRANDOL","KASZANKA",
"PARASOLKA","GILOTYNA","PANCERNIK","≈öRUBOKRƒòT","SATELITA","KOCIO≈ÅEK","DONICZKA",
"PIEKARNIK","SZACHISTA","GRZYBNIA","ANANAS","TRƒÑBKA","SPAGHETTI","MARCHEWKA"];

let playerId = Math.random().toString(36).substring(2,9);
let roomRef = null;
let isHost = false;
let playerName = "";
let voteState = {}; // kto g≈Çosowa≈Ç
let voteTarget = null;

function randomCode() { return Math.floor(1000 + Math.random() * 9000).toString(); }

function showMyName() {
  const nameDiv = document.getElementById("myName");
  nameDiv.innerText = `Twoje imiƒô: ${playerName}`;
  nameDiv.classList.remove("hidden");
}

function showResult(text) {
  const resultDiv = document.getElementById("result");
  resultDiv.innerText = text;
  resultDiv.classList.remove("hidden");
}

async function updatePlayerList() {
  const snap = await roomRef.get();
  const data = snap.val();
  const playersList = data.players ? Object.values(data.players).map(p => p.name) : [];
  document.getElementById("playerList").innerText = playersList.join(", ");
  const nonHostCount = playersList.filter(n => !n.includes("(HOST)")).length;
  document.getElementById("players").innerText = `Gracze: ${nonHostCount}/4`;
}

// Tworzenie pokoju
window.createRoom = async function() {
  playerName = document.getElementById("playerName").value.trim();
  if (!playerName) return alert("Podaj imiƒô!");
  playerName += " (HOST)";
  isHost = true;
  showMyName();

  const code = randomCode();
  roomRef = db.ref("rooms/" + code);
  await roomRef.set({ players: {}, started: false });

  document.getElementById("menu").classList.add("hidden");
  document.getElementById("hostPanel").classList.remove("hidden");
  document.getElementById("roomCode").innerText = code;

  const playerRef = db.ref(`rooms/${code}/players/${playerId}`);
  await playerRef.set({ name: playerName });

  roomRef.on("value", async snapshot => {
    await updatePlayerList();
    const data = snapshot.val();
    if (data.started && data.roles && data.word) {
      const role = data.roles[playerId];
      if (role === "impostor") showResult("üïµÔ∏è‚Äç‚ôÇÔ∏è JESTE≈ö IMPOSTOREM!");
      else if (role !== "host") showResult(`üî§ Has≈Ço: ${data.word}`);
    }
    if (!isHost && data.vote) setupVotePanel(data);
  });
}

// Do≈ÇƒÖczenie do pokoju
window.joinRoom = async function() {
  playerName = document.getElementById("playerName").value.trim();
  if (!playerName) return alert("Podaj imiƒô!");
  showMyName();

  const code = document.getElementById("joinCode").value.trim();
  if (!code) return alert("Podaj kod pokoju!");
  roomRef = db.ref("rooms/" + code);

  roomRef.get().then(async snapshot => {
    if (!snapshot.exists()) return alert("Pok√≥j nie istnieje!");

    const playerRef = db.ref(`rooms/${code}/players/${playerId}`);
    playerRef.set({ name: playerName });

    document.getElementById("menu").classList.add("hidden");
    document.getElementById("waiting").classList.remove("hidden");

    roomRef.on("value", snapshot => {
      updatePlayerList();
      const data = snapshot.val();
      if (data.started && data.roles && data.word) {
        const role = data.roles[playerId];
        if (role === "impostor") showResult("üïµÔ∏è‚Äç‚ôÇÔ∏è JESTE≈ö IMPOSTOREM!");
        else if (role !== "host") showResult(`üî§ Has≈Ço: ${data.word}`);
      }
      if (!isHost && data.vote) setupVotePanel(data);
    });
  });
}

// Rozpoczƒôcie gry (host)
window.startGame = async function() {
  const snap = await roomRef.get();
  const data = snap.val();
  const players = Object.keys(data.players || {}).filter(id => !data.players[id].name.includes("(HOST)"));
  if (players.length !== 4) return alert("Musi byƒá dok≈Çadnie 4 graczy (bez hosta)!");

  const word = words[Math.floor(Math.random() * words.length)];
  const impostor = players[Math.floor(Math.random() * players.length)];
  const roles = {};
  players.forEach(p => roles[p] = p === impostor ? "impostor" : "normal");
  roles[playerId] = "host";

  await roomRef.update({ started: true, roles, word, vote: null });
  document.getElementById("btnNextRound").classList.remove("hidden");
  showResult("Runda rozpoczƒôta!");
}

// Kolejna runda (host)
window.nextRound = async function() {
  const snap = await roomRef.get();
  const data = snap.val();
  const players = Object.keys(data.players || {}).filter(id => !data.players[id].name.includes("(HOST)"));
  const word = words[Math.floor(Math.random() * words.length)];
  const impostor = players[Math.floor(Math.random() * players.length)];
  const roles = {};
  players.forEach(p => roles[p] = p === impostor ? "impostor" : "normal");
  roles[playerId] = "host";

  await roomRef.update({ started: true, roles, word, vote: null });
  document.getElementById("result").classList.add("hidden");
  document.getElementById("votePanel").classList.add("hidden");
}

// ------------------- MECHANIKA OSKAR≈ªANIA -------------------
function setupVotePanel(data) {
  const voteDiv = document.getElementById("votePanel");
  voteDiv.classList.remove("hidden");
  const voteButtonsDiv = document.getElementById("voteButtons");
  voteButtonsDiv.innerHTML = "";

  // lista graczy do oskar≈ºenia
  Object.keys(data.players).forEach(pid => {
    if (pid !== playerId && !data.players[pid].name.includes("(HOST)")) {
      const btn = document.createElement("button");
      btn.className = "vote-button";
      btn.innerText = data.players[pid].name;
      btn.onclick = () => castVote(pid);
      voteButtonsDiv.appendChild(btn);
    }
  });

  document.getElementById("voteStatus").innerText = "Wybierz gracza do oskar≈ºenia üïµÔ∏è‚Äç‚ôÇÔ∏è";
}

async function castVote(targetId) {
  voteTarget = targetId;
  const voteRef = roomRef.child("vote");
  const snap = await voteRef.get();
  let voteData = snap.exists() ? snap.val() : { target: targetId, votes: {} };

  if (!voteData.votes[playerId]) voteData.votes[playerId] = "yes";
  await voteRef.set(voteData);

  document.getElementById("voteStatus").innerText = "‚è≥ TRWA G≈ÅOSOWANIE...";
}

// nas≈Çuch g≈Ços√≥w
roomRef?.child("vote")?.on("value", snap => {
  const voteData = snap.val();
  if (!voteData) return;
  const totalPlayers = Object.keys(roomRef?.get()?.players || {}).filter(id => id !== playerId && !id.includes("(HOST)")).length;
  const votesCount = Object.keys(voteData.votes).length;

  document.getElementById("voteStatus").innerText = `üó≥Ô∏è Zag≈Çosowano: ${votesCount}/${totalPlayers + 1}`;

  // wszyscy g≈Çosowali
  if (votesCount >= totalPlayers + 1) {
    const targetName = roomRef?.get()?.players[voteData.target]?.name;
    roomRef.child("roles").get().then(snapRoles => {
      const roles = snapRoles.val();
      const impostorId = Object.keys(roles).find(k => roles[k]==="impostor");
      let msg = `‚úÖ Wszyscy zag≈Çosowali ZA! Gracz ${targetName} zosta≈Ç wskazany.`;
      if (voteData.target === impostorId) msg += ` üïµÔ∏è‚Äç‚ôÇÔ∏è To by≈Ç impostor!`;
      else msg += ` ‚ùå Niestety to nie by≈Ç impostor.`;
      showResult(msg);
      document.getElementById("votePanel").classList.add("hidden");
      roomRef.child("vote").remove();
    });
  }
});

document.getElementById("btnCreate").addEventListener("click", createRoom);
document.getElementById("btnJoin").addEventListener("click", joinRoom);
document.getElementById("btnStart").addEventListener("click", startGame);
document.getElementById("btnNextRound").addEventListener("click", nextRound);
</script>
</body>
</html>
